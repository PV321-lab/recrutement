<!DOCTYPE html>
<html>
<head>
    <title>Test Firebase Connexion</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            background: #3367d6;
        }
        
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 14px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #b3d7ff;
        }
        
        .data-section {
            margin-top: 20px;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #4285f4;
        }
        
        h3 {
            color: #333;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 5px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .retry-btn {
            background: #ff9800;
            margin-left: 10px;
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .retry-btn:hover {
            background: #f57c00;
        }
    </style>
</head>
<body>
    <h2>üîç Test Connexion Firebase</h2>
    
    <div class="info-box">
        <strong>Configuration utilis√©e :</strong><br>
        Projet: <code>dddiii-2b58b</code><br>
        Email: <code>g.marouane@outlook.fr</code><br>
        R√©gion DB: <code>asia-southeast1</code>
    </div>
    
    <button onclick="testerConnexion()" id="testBtn">
        <span id="btnText">üîó TESTER LA CONNEXION ET LIRE LES DONN√âES</span>
    </button>
    
    <button onclick="testerConnexion()" id="retryBtn" class="retry-btn" style="display: none;">
        üîÑ R√©essayer
    </button>
    
    <div id="result"></div>
    
    <div id="dataDisplay" class="data-section"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // VOTRE CONFIGURATION EXACTE
        const firebaseConfig = {
            apiKey: "AIzaSyC6uSDTNCuw5sHNVaNgq0EzJqJZ9jgic7U",
            authDomain: "dddiii-2b58b.firebaseapp.com",
            databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dddiii-2b58b",
            storageBucket: "dddiii-2b58b.firebasestorage.app",
            messagingSenderId: "721468171485",
            appId: "1:721468171485:web:420e2e0ab98b95fa2ae734",
            measurementId: "G-QGFM2N76VK"
        };

        let firebaseInitialized = false;
        let auth = null;
        let database = null;
        let currentUser = null;

        // Initialiser Firebase d√®s le chargement de la page
        function initialiserFirebase() {
            if (firebaseInitialized) {
                return Promise.resolve();
            }
            
            return new Promise((resolve, reject) => {
                try {
                    // V√©rifier si Firebase est d√©j√† charg√©
                    if (typeof firebase === 'undefined') {
                        reject(new Error("Firebase SDK non charg√©"));
                        return;
                    }
                    
                    // Fermer les anciennes instances si elles existent
                    if (firebase.apps.length > 0) {
                        const defaultApp = firebase.apps.find(app => app.name === '[DEFAULT]');
                        if (defaultApp) {
                            resolve(); // Firebase d√©j√† initialis√©
                            return;
                        }
                    }
                    
                    // Initialiser Firebase
                    const app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    database = firebase.database();
                    
                    // Configurer le timeout pour les requ√™tes r√©seau
                    database.ref('.info/connected').on('value', (snap) => {
                        console.log("√âtat connexion DB:", snap.val() ? "connect√©" : "d√©connect√©");
                    });
                    
                    firebaseInitialized = true;
                    console.log("Firebase initialis√© avec succ√®s");
                    resolve();
                    
                } catch (error) {
                    console.error("Erreur initialisation Firebase:", error);
                    reject(error);
                }
            });
        }

        // Tester la connexion r√©seau
        async function testerConnexionReseau() {
            return new Promise((resolve) => {
                const timeout = setTimeout(() => {
                    resolve(false);
                }, 3000);
                
                fetch('https://firebase.googleapis.com', { mode: 'no-cors' })
                    .then(() => {
                        clearTimeout(timeout);
                        resolve(true);
                    })
                    .catch(() => {
                        clearTimeout(timeout);
                        resolve(false);
                    });
            });
        }

        async function testerConnexion() {
            const resultDiv = document.getElementById('result');
            const dataDiv = document.getElementById('dataDisplay');
            const testBtn = document.getElementById('testBtn');
            const retryBtn = document.getElementById('retryBtn');
            const btnText = document.getElementById('btnText');
            
            // R√©initialiser l'affichage
            resultDiv.innerHTML = "";
            dataDiv.innerHTML = "";
            resultDiv.className = "loading";
            
            // D√©sactiver le bouton pendant le test
            testBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Test en cours...';
            retryBtn.style.display = 'none';
            
            try {
                // √âtape 0: V√©rifier la connexion r√©seau
                resultDiv.innerHTML = "üîç V√©rification de la connexion r√©seau...\n";
                
                const reseauOK = await testerConnexionReseau();
                if (!reseauOK) {
                    throw new Error("Probl√®me de connexion r√©seau d√©tect√©");
                }
                
                resultDiv.innerHTML += "‚úì Connexion r√©seau OK\n";
                
                // √âtape 1: Initialiser Firebase (attendre que ce soit pr√™t)
                resultDiv.innerHTML += "1. Initialisation de Firebase...\n";
                
                await initialiserFirebase();
                
                // Attendre que Firebase soit vraiment pr√™t
                await new Promise(resolve => setTimeout(resolve, 500));
                
                resultDiv.innerHTML += "‚úì Firebase initialis√©\n";
                resultDiv.innerHTML += "2. Connexion avec les identifiants...\n";
                
                // √âtape 2: Connexion avec email/mot de passe
                const email = "g.marouane@outlook.fr";
                const password = "M@ra10";
                
                // Ajouter un timeout pour la connexion
                const loginPromise = auth.signInWithEmailAndPassword(email, password);
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error("Timeout de connexion")), 10000);
                });
                
                const userCredential = await Promise.race([loginPromise, timeoutPromise]);
                currentUser = userCredential.user;
                
                resultDiv.innerHTML += `‚úì Connect√© avec succ√®s!\n`;
                resultDiv.innerHTML += `   UID: ${currentUser.uid}\n`;
                resultDiv.innerHTML += `   Email: ${currentUser.email}\n`;
                resultDiv.innerHTML += "3. Lecture de la base de donn√©es...\n";
                
                // √âtape 3: Lire TOUTES les donn√©es avec retry
                let retryCount = 0;
                let snapshot = null;
                
                while (retryCount < 3 && !snapshot) {
                    try {
                        const readPromise = database.ref('/').once('value');
                        const readTimeout = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error("Timeout de lecture")), 8000);
                        });
                        
                        snapshot = await Promise.race([readPromise, readTimeout]);
                    } catch (readError) {
                        retryCount++;
                        if (retryCount < 3) {
                            resultDiv.innerHTML += `   Tentative ${retryCount + 1}/3...\n`;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } else {
                            throw readError;
                        }
                    }
                }
                
                if (snapshot.exists()) {
                    const allData = snapshot.val();
                    resultDiv.innerHTML += `‚úì Donn√©es trouv√©es!\n`;
                    resultDiv.innerHTML += `   Nombre d'√©l√©ments: ${Object.keys(allData).length}\n\n`;
                    
                    // Afficher les donn√©es de mani√®re organis√©e
                    dataDiv.innerHTML = '<h3>üìä DONN√âES DE LA BASE :</h3>';
                    
                    Object.keys(allData).forEach(key => {
                        const value = allData[key];
                        const dataItem = document.createElement('div');
                        dataItem.className = 'data-item';
                        
                        if (typeof value === 'object' && value !== null) {
                            dataItem.innerHTML = `
                                <strong>${key}:</strong><br>
                                <pre>${JSON.stringify(value, null, 2)}</pre>
                            `;
                        } else {
                            dataItem.innerHTML = `<strong>${key}:</strong> ${value}`;
                        }
                        
                        dataDiv.appendChild(dataItem);
                    });
                    
                    // Afficher aussi le JSON brut
                    const rawDataDiv = document.createElement('div');
                    rawDataDiv.className = 'data-item';
                    rawDataDiv.innerHTML = `
                        <strong>JSON Complet :</strong><br>
                        <pre>${JSON.stringify(allData, null, 2)}</pre>
                    `;
                    dataDiv.appendChild(rawDataDiv);
                    
                    resultDiv.className = "success";
                    
                } else {
                    resultDiv.innerHTML += "‚úì Connexion DB r√©ussie mais aucune donn√©e trouv√©e\n";
                    dataDiv.innerHTML = '<h3>‚ÑπÔ∏è Base de donn√©es vide</h3>';
                    resultDiv.className = "success";
                }
                
                // R√©activer le bouton
                testBtn.disabled = false;
                btnText.innerHTML = 'üîó TESTER LA CONNEXION ET LIRE LES DONN√âES';
                
            } catch (error) {
                // Afficher l'erreur d√©taill√©e
                resultDiv.innerHTML = `‚ùå ERREUR:\n`;
                resultDiv.innerHTML += `Code: ${error.code || 'N/A'}\n`;
                resultDiv.innerHTML += `Message: ${error.message}\n\n`;
                
                // Diagnostic selon le type d'erreur
                resultDiv.innerHTML += `üîç DIAGNOSTIC:\n`;
                
                if (error.code === 'auth/network-request-failed' || error.message.includes('network') || error.message.includes('Network')) {
                    resultDiv.innerHTML += `- Probl√®me r√©seau d√©tect√©\n`;
                    resultDiv.innerHTML += `- Solution: R√©essayez en cliquant sur le bouton "R√©essayer"\n`;
                    resultDiv.innerHTML += `- Conseil: Attendez que la page soit compl√®tement charg√©e\n`;
                    
                    // Afficher le bouton de r√©essai
                    retryBtn.style.display = 'inline-block';
                }
                else if (error.code === 'auth/invalid-api-key') {
                    resultDiv.innerHTML += `- La cl√© API est invalide\n`;
                } 
                else if (error.code === 'auth/user-not-found') {
                    resultDiv.innerHTML += `- L'utilisateur n'existe pas\n`;
                }
                else if (error.code === 'auth/wrong-password') {
                    resultDiv.innerHTML += `- Mot de passe incorrect\n`;
                }
                else if (error.message.includes('permission_denied')) {
                    resultDiv.innerHTML += `- Permission refus√©e par les r√®gles de s√©curit√©\n`;
                }
                else {
                    resultDiv.innerHTML += `- Erreur: ${error.message}\n`;
                }
                
                resultDiv.innerHTML += `\nüí° CONSEIL: Cliquez sur "R√©essayer" - la 2√®me tentative marche souvent mieux`;
                
                resultDiv.className = "error";
                
                // R√©activer le bouton principal
                testBtn.disabled = false;
                btnText.innerHTML = 'üîó TESTER √Ä NOUVEAU';
                
                console.error("Erreur compl√®te:", error);
            }
        }

        // Initialiser Firebase au chargement de la page
        window.addEventListener('load', async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 
                "üì± Page charg√©e. Initialisation de Firebase en arri√®re-plan...\n" +
                "‚û°Ô∏è Cliquez sur le bouton pour tester la connexion\n\n" +
                "üí° Conseil: Attendez 2-3 secondes apr√®s le chargement de la page\n" +
                "            avant de cliquer pour √©viter les erreurs r√©seau.";
            resultDiv.className = "info-box";
            
            // Initialiser Firebase silencieusement
            try {
                await initialiserFirebase();
                console.log("Firebase pr√©-initialis√© avec succ√®s");
            } catch (error) {
                console.warn("Initialisation silencieuse √©chou√©e, mais ce n'est pas grave:", error.message);
            }
        });
    </script>
</body>
</html>