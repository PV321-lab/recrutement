<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root{--c1:#007bff;--bg:#f0f2f5;--ok:#0f9d58;--warn:#f4b400;--err:#d93025;--info:#4285f4;}
    body{font-family:Arial,sans-serif;margin:16px;background:var(--bg);}
    h2{text-align:center;margin:8px 0 16px;}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);margin-bottom:16px;}
    label{font-weight:600;display:block;margin-top:10px;}
    input,select,button{font-size:16px;}
    input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:8px;}
    input[readonly]{background:#e9ecef;}
    button{margin-top:14px;padding:10px 14px;border:none;border-radius:10px;background:var(--c1);color:#fff;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;}
    th{background:var(--c1);color:#fff;}
    .hidden{display:none !important;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .col{flex:1 1 220px;min-width:220px;}
    .banner{padding:10px 12px;border-radius:10px;margin-bottom:12px;font-weight:600;}
    .banner.info{background:#e8f0fe;color:#174ea6;border:1px solid #c6dafc;}
    .banner.ok{background:#e6f4ea;color:#137333;border:1px solid #cce8d3;}
    .banner.warn{background:#fef7e0;color:#a66300;border:1px solid #fde293;}
    .banner.err{background:#fce8e6;color:#a50e0e;border:1px solid #f7b9b4;}
    .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;}
    .note{font-size:13px;opacity:.8;}
    .person-group{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #e9ecef;}
    .person-group h4{margin:0 0 10px 0;color:#1E40AF;}
    .consent-container{margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;}
    .consent-text{max-height:150px;overflow-y:auto;padding:10px;background:white;border-radius:5px;border:1px solid #ced4da;margin:10px 0;}
    .btn-delete{background:var(--err) !important;margin-left:5px;}
    .signature-area{margin:40px 0;padding:20px;border:2px solid #ddd;border-radius:8px;text-align:center;}
    .signature-title{font-size:18px;margin-bottom:20px;color:#2c3e50;}
    .signature-canvas{width:100%;height:200px;border:1px solid #ccc;border-radius:5px;background:white;cursor:crosshair;margin-bottom:20px;}
    .doc-type-row{display:flex;gap:10px;}
    .doc-type-row .col{flex:1;}
    .rules-container{margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;max-height:250px;overflow-y:auto;}
    .rules-container h4{margin-top:0;color:#2c3e50;}
    .rules-container ul{padding-left:20px;margin:10px 0;}
    .rules-container li{margin-bottom:8px;}
    .signature-controls{display:flex;gap:10px;justify-content:center;margin-top:15px;}
  </style>
</head>
<body>
<h2>Enregistrement des invités</h2>
<div id="banner" class="banner info hidden"></div>
<div id="loginCard" class="card">
  <div class="toolbar">
    <div><strong>Connexion</strong></div>
    <div class="note">Veuillez entrer vos identifiants</div>
  </div>
  <label>Utilisateur</label>
  <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required />
  <label>Mot de passe</label>
  <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required />
  <button id="btnLogin" onclick="login()">Connexion</button>
  <p id="loginMsg" class="banner err hidden"></p>
</div>
<div id="adminPanel" class="hidden">
  <!-- Contenu du panneau admin inchangé -->
</div>
<div id="userPanel" class="hidden">
  <!-- Contenu du panneau user inchangé -->
</div>
<div id="invitePanel" class="hidden">
  <!-- Contenu du panel invité inchangé -->
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC6uSDTNCuw5sHNVaNgq0EzJqJZ9jgic7U",
    authDomain: "dddiii-2b58b.firebaseapp.com",
    databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dddiii-2b58b",
    storageBucket: "dddiii-2b58b.firebasestorage.app",
    messagingSenderId: "721468171485",
    appId: "1:721468171485:web:420e2e0ab98b95fa2ae734",
    measurementId: "G-QGFM2N76VK"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let currentUser = null;
  const SESSION_TIMEOUT_MS = 10 * 60 * 1000;
  let sessionTimer = null;
  let signatureData = '';
  let hasSignature = false;

  function showBanner(type, text){ const b = document.getElementById('banner'); b.className='banner '+type; b.textContent=text; b.classList.remove('hidden'); }
  function hideBanner(){ document.getElementById('banner').classList.add('hidden'); }
  function showInlineMsg(elId,type,text){ const el=document.getElementById(elId); el.textContent=text; el.className='banner '+type; el.classList.remove('hidden'); }
  function hideInlineMsg(elId){ document.getElementById(elId).classList.add('hidden'); }

  function startSessionTimer(){ stopSessionTimer(); sessionTimer=setTimeout(()=>{ logout(true); showBanner('warn',"Session expirée (inactivité). Veuillez vous reconnecter."); },SESSION_TIMEOUT_MS); }
  function stopSessionTimer(){ if(sessionTimer){ clearTimeout(sessionTimer); sessionTimer=null; } }
  function resetSessionTimer(){ if(currentUser) startSessionTimer(); }
  ['click','keydown','touchstart'].forEach(evt=>document.addEventListener(evt,resetSessionTimer,{passive:true}));

  function logout(expired=false){ currentUser=null; stopSessionTimer(); document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('userPanel').classList.add('hidden'); document.getElementById('invitePanel').classList.add('hidden'); document.getElementById('loginCard').classList.remove('hidden'); if(!expired) showBanner('info',"Vous êtes déconnecté."); }

  async function login(){
    hideInlineMsg('loginMsg');
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    if(!u||!p){ showInlineMsg('loginMsg','err',"Saisissez l'utilisateur et le mot de passe."); return; }
    if(u==='admin'&&p==='admin'){ currentUser={role:'admin'}; document.getElementById('loginCard').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); showBanner('ok',"Connecté en tant qu'administrateur."); startSessionTimer(); refreshAdmin(); return; }
    try{
      const snapshot=await database.ref('users/'+u).once('value'); const user=snapshot.val();
      if(user&&user.pass===p){ currentUser={role:'user',id:u,appart:user.appart,bat:user.bat}; document.getElementById('loginCard').classList.add('hidden'); document.getElementById('userPanel').classList.remove('hidden'); showBanner('ok',`Connecté. Appartement ${user.appart} / Immeuble ${user.bat}.`); startSessionTimer(); refreshUser(); }
      else showInlineMsg('loginMsg','err',"Identifiants incorrects.");
    }catch(e){ console.error(e); showInlineMsg('loginMsg','err',"Erreur d'accès à la base de données. Vérifiez les règles de sécurité Firebase."); }
  }

  // Toutes les autres fonctions (creerUtilisateur, refreshAdmin, refreshUser, genererLien, signature, PDF, WhatsApp) restent inchangées
  document.getElementById('btnLogin').disabled=false;
  const params=new URLSearchParams(location.search);
  if(params.has("invite")) enterInviteMode(params.get("invite"));
</script>
</body>
</html>