```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Premium Village - Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root{
      --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4;
    }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; color: #2c3e50; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, select, button { font-size:16px; }
    input, select { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:220px; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; opacity:.8; }
    .recap{ background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:8px; min-width:240px; }
    .person-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef; }
    .person-group h4 { margin: 0 0 10px 0; color: #1E40AF; }
    .consent-container { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; }
    .consent-text { max-height: 150px; overflow-y: auto; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ced4da; margin: 10px 0; }
    .btn-delete { background: var(--err) !important; margin-left: 5px; }
    .signature-area { margin: 40px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
    .signature-title { font-size: 18px; margin-bottom: 20px; color: #2c3e50; }
    .signature-canvas { width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 5px; background: white; cursor: crosshair; margin-bottom: 20px; }
    .doc-type-row { display: flex; gap: 10px; }
    .doc-type-row .col { flex: 1; }
    .rules-container { 
      margin: 20px 0; 
      padding: 15px; 
      background: #f8f9fa; 
      border-radius: 8px; 
      border: 1px solid #dee2e6;
      max-height: 250px;
      overflow-y: auto;
    }
    .rules-container h4 { margin-top: 0; color: #2c3e50; }
    .rules-container ul { padding-left: 20px; margin: 10px 0; }
    .rules-container li { margin-bottom: 8px; }
    .signature-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .document-column { 
      border-left: 2px solid #007bff; 
      padding-left: 20px; 
      min-height: 100vh;
      background: #f9f9f9;
    }
    .document-preview { 
      background: white; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    .doc-title { 
      text-align: center; 
      font-size: 24px; 
      font-weight: bold; 
      color: #2c3e50; 
      margin-bottom: 30px; 
      border-bottom: 2px solid #2c3e50; 
      padding-bottom: 10px;
    }
    .doc-info { margin-bottom: 20px; }
    .doc-info p { margin: 5px 0; }
    .doc-section { margin-bottom: 30px; }
    .doc-section-title { 
      font-size: 18px; 
      font-weight: bold; 
      color: #2c3e50; 
      margin-bottom: 10px; 
      border-bottom: 1px solid #ddd; 
      padding-bottom: 5px;
    }
    .doc-signature { 
      text-align: center; 
      margin-top: 40px; 
      padding-top: 20px; 
      border-top: 2px solid #2c3e50;
    }
    .doc-signature-box { 
      border: 1px solid #000; 
      height: 100px; 
      margin: 20px auto; 
      width: 300px; 
      position: relative;
    }
    .two-column-layout {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .form-column {
      flex: 2;
      min-width: 300px;
    }
    .document-column {
      flex: 1;
      min-width: 300px;
    }
    .doc-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .nationality-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .nationality-row .col {
      flex: 1;
    }
    .accept-signature-container {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    .premium-header {
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    .user-settings {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      margin-top: 15px;
    }
    .email-settings {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      margin-top: 15px;
    }
    .email-settings h4 {
      margin-top: 0;
      color: #2c3e50;
    }
    .signature-preview {
      border: 2px solid #000;
      background: white;
      margin: 10px auto;
      max-width: 300px;
    }
    .error-message {
      color: #d93025;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    .error-border {
      border-color: #d93025 !important;
    }
    .smtp-info {
      background: #e8f4f8;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 13px;
      border-left: 4px solid #007bff;
    }
  </style>
</head>
<body>

<div class="premium-header">
  <h1>Premium Village</h1>
  <p>Gestion des enregistrements des invités</p>
</div>

<div class="two-column-layout">
  <div class="form-column">
    <div id="banner" class="banner info hidden"></div>

    <div id="loginCard" class="card">
      <div class="toolbar">
        <div><strong>Connexion - Premium Village</strong></div>
        <div class="note">Veuillez entrer vos identifiants</div>
      </div>
      <label>Utilisateur</label>
      <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required />
      <label>Mot de passe</label>
      <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required />
      <button id="btnLogin" onclick="login()">Connexion</button>
      <p id="loginMsg" class="banner err hidden"></p>
    </div>

    <div id="adminPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Panneau administrateur - Premium Village</strong></div>
        <div>
          <button onclick="logout()">Déconnexion</button>
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Gestion des utilisateurs</strong></div>
        </div>
        <div class="row">
          <div class="col">
            <label>Appartement</label>
            <input type="text" id="appartAdmin" placeholder="Ex: 12" />
          </div>
          <div class="col">
            <label>Immeuble</label>
            <input type="text" id="batAdmin" placeholder="Ex: A" />
          </div>
          <div class="col">
            <label>Mot de passe</label>
            <input type="text" id="passAdmin" placeholder="Choisir un mot de passe" />
          </div>
        </div>
        <button onclick="creerUtilisateur()">Créer utilisateur</button>
        <p id="userWarn" class="banner warn hidden"></p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Utilisateurs existants</strong></div>
        </div>
        <table id="tableUsers">
          <thead>
            <tr><th>N°</th><th>Appartement</th><th>Immeuble</th><th>Mot de passe</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Enregistrements des invités</strong></div>
        </div>
        <table id="tableAdmin">
          <thead>
            <tr>
              <th>N°</th><th>Appart.</th><th>Immeuble</th><th>Nom</th><th>Document</th><th>Type Doc</th><th>Nationalité</th>
              <th>Nb Pers.</th><th>Personnes</th><th>Date</th><th>Document</th><th>Action</th><th>Statut</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="userPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Mon espace - Premium Village</strong></div>
        <div><button onclick="logout()">Déconnexion</button></div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Paramètres de mon compte</strong></div>
        </div>
        <div class="user-settings">
          <div class="row">
            <div class="col">
              <label>Nombre maximum d'enregistrements</label>
              <input type="number" id="maxRecords" min="1" value="10" />
            </div>
            <div class="col">
              <label>Nouveau mot de passe (optionnel)</label>
              <input type="password" id="newPassword" placeholder="Laisser vide pour ne pas changer" />
            </div>
          </div>
          <button onclick="updateUserSettings()">Enregistrer les paramètres</button>
          <p id="settingsMsg" class="banner hidden"></p>
        </div>
        
        <div class="email-settings">
          <h4>Notifications par Email</h4>
          <p class="note">Recevez une notification quand un invité s'enregistre.</p>
          
          <label>Activer les notifications</label>
          <select id="enableEmail" onchange="toggleEmailFields()">
            <option value="non">Non</option>
            <option value="oui">Oui</option>
          </select>
          
          <div id="emailFields" class="hidden">
            <div class="smtp-info">
              <strong>Configuration EmailJS :</strong> L'email sera envoyé automatiquement au destinataire configuré.
            </div>
            
            <label>Email du destinataire (ex: Sécurité)</label>
            <input type="email" id="guardEmail" placeholder="destinataire@exemple.com" required />
          </div>
          
          <div class="row" style="margin-top: 15px;">
            <button onclick="saveEmailSettings()" style="flex: 1;">Enregistrer Email</button>
            <button onclick="testEmailSettings()" style="flex: 1; background: var(--ok);">Tester l'envoi</button>
          </div>
          <p id="emailMsg" class="banner hidden"></p>
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Mes enregistrements</strong></div>
          <button onclick="genererLien()" style="background: var(--ok);">Générer lien invité</button>
        </div>
        <table id="tableUser">
          <thead>
            <tr>
              <th>N°</th><th>Nom</th><th>Document</th><th>Type Doc</th><th>Nationalité</th><th>Nb Pers.</th><th>Personnes</th><th>Date</th><th>Document</th><th>Statut</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="invitePanel" class="hidden">
      <div class="guest-form-container">
        <div class="toolbar" style="margin-bottom: 20px;">
          <h3 style="margin: 0; flex-grow: 1;">Enregistrement Invité - Premium Village</h3>
        </div>

        <div class="card">
          <form id="guestForm">
            <div class="row">
              <div class="col">
                <label>Appartement</label>
                <input type="text" id="invAppart" readonly />
              </div>
              <div class="col">
                <label>Immeuble</label>
                <input type="text" id="invBat" readonly />
              </div>
            </div>

            <label>Date d'arrivée *</label>
            <input type="date" id="dateArrivee" required class="guest-input" />
            <div class="error-message" id="dateArriveeError">Veuillez sélectionner une date d'arrivée</div>

            <label>Nombre des invités *</label>
            <input type="number" id="nbPers" min="1" value="1" onchange="genererChamps()" required class="guest-input" />
            <div class="error-message" id="nbPersError">Veuillez entrer le nombre d'invités (minimum 1)</div>

            <label>Nom et Prénom de la personne principale *</label>
            <input type="text" id="nomPrincipal" required placeholder="Nom complet" class="guest-input" />
            <div class="error-message" id="nomPrincipalError">Veuillez entrer le nom et prénom</div>

            <div class="row doc-type-row">
              <div class="col">
                <label>Type de document *</label>
                <select id="typeDocPrincipal" required class="guest-input">
                  <option value="">Sélectionner</option>
                  <option value="Passeport">Passeport</option>
                  <option value="Carte d'identité">Carte d'identité</option>
                </select>
                <div class="error-message" id="typeDocPrincipalError">Veuillez sélectionner un type de document</div>
              </div>
              <div class="col">
                <label>Numéro de document *</label>
                <input type="text" id="docPrincipal" required placeholder="N° de document" class="guest-input" />
                <div class="error-message" id="docPrincipalError">Veuillez entrer le numéro de document</div>
              </div>
            </div>

            <div class="nationality-row">
              <div class="col">
                <label>Nationalité *</label>
                <input type="text" id="nationalitePrincipal" required placeholder="Nationalité" class="guest-input" />
                <div class="error-message" id="nationalitePrincipalError">Veuillez entrer la nationalité</div>
              </div>
            </div>

            <div id="personnes"></div>

            <div class="rules-container">
              <h4>Règlement intérieur à respecter :</h4>
              <ul>
                <li><strong>1. Si vous êtes des Couples marocains: :</strong> selon la loi marocaine Ce logement autorise que les couples mariés . </li>
                <li><strong>2. Tranquillité et bruit :</strong> Silence total obligatoire après 23h00. Pas de musique forte, cris ou nuisances sonores à toute heure.</li>
                <li><strong>3. Tabagisme :</strong> Fumer est strictement interdit à l'intérieur. Autorisé uniquement en extérieur (terrasse ou jardin), avec obligation de nettoyer les mégots et cendres.</li>
                <li><strong>4. Nombre de personnes :</strong> Maximum 5 personnes autorisées dans l'appartement.</li>
                <li><strong>5. Piscine :</strong> Douche obligatoire avant la baignade. Pas de verre ni objets fragiles autour de la piscine. Surveillance permanente des enfants par un adulte. Horaires : fermeture à 20h00. Pas de courses ni plongeons.</li>
                <li><strong>6. Propreté et entretien :</strong> Maintenir les lieux propres en permanence. Vider régulièrement les poubelles. Respecter les sols et surfaces (pas de traces, pas de nourriture hors cuisine).</li>
              </ul>
            </div>

            <div class="signature-area">
              <div class="signature-title">Signature *</div>
              <canvas id="signatureCanvas" class="signature-canvas">
                Votre navigateur ne supporte pas la signature.
              </canvas>
              <div class="error-message" id="signatureError">Veuillez signer le document</div>
              <div class="signature-controls">
                <button type="button" id="clearBtn" class="btn" style="background: #e74c3c;">Effacer la signature</button>
              </div>
              <div id="signaturePreview" class="signature-preview hidden"></div>
              <p style="margin-top: 15px; font-size: 14px; color: #666;">
                En signant, vous acceptez le règlement intérieur et consentez au traitement de vos données personnelles conformément à la loi marocaine n° 09-08 relative à la protection des personnes physiques à l'égard du traitement des données à caractère personnel, ainsi qu'aux dispositions de la loi 31-08 édictant des mesures de protection des consommateurs.
              </p>
            </div>

            <div class="accept-signature-container">
              <label style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <input type="checkbox" id="acceptCheckbox" required style="margin-right: 10px; width: auto;">
                <span style="font-size: 16px; font-weight: bold;">Je confirme avoir lu et j'accepte le règlement intérieur ainsi que le traitement de mes données personnelles conformément aux lois marocaines sur la protection des données (loi 09-08) et aux dispositions légales en vigueur.</span>
              </label>
              <div class="error-message" id="acceptCheckboxError" style="text-align: center;">Veuillez accepter les conditions</div>
              <div style="text-align: center;">
                <button type="button" id="registerBtn" class="btn" style="background: #27ae60; padding: 12px 30px; font-size: 18px;">Enregistrer et valider</button>
              </div>
            </div>
          </form>
        </div>

        <div id="successMessage" class="banner ok hidden">
          Enregistrement réussi ! Un onglet s'ouvre avec votre document PDF.
          <br><br>
          <strong>Note importante :</strong> En cas de demande des agents de sécurité, présentez ce document signé.
          Seules les personnes enregistrées dans cette réservation sont autorisées à entrer.
        </div>
      </div>
    </div>
  </div>

  <div id="documentColumn" class="document-column hidden">
    <div class="card">
      <h3>Document Signé - Premium Village</h3>
      <div id="documentPreview" class="document-preview">
        <p style="text-align: center; color: #666;">Sélectionnez un enregistrement pour voir le document.</p>
      </div>
      <div id="docActions" class="doc-actions hidden">
        <button onclick="downloadCurrentDocument()" style="background: var(--ok);">Télécharger PDF</button>
        <button onclick="partagerWhatsApp()" style="background: #25D366;">Partager WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDbJe_e0Uz5YavmQDwabym11FStEPjxo2E",
    authDomain: "invitedb-6ce9f.firebaseapp.com",
    databaseURL: "https://invitedb-6ce9f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "invitedb-6ce9f",
    storageBucket: "invitedb-6ce9f.firebasestorage.app",
    messagingSenderId: "253833375693",
    appId: "1:253833375693:web:a1d68bef41916c86be5e84",
    measurementId: "G-BS2EBMM7T3"
  };
  
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  } catch (e) {
    console.error("Firebase Init Error:", e);
  }
  const database = firebase.database();
  const AUTH_EMAIL = "maraminho10@gmail.com";
  const AUTH_PASS = "M@ra10";

  let currentUser = null;
  const SESSION_TIMEOUT_MS = 10 * 60 * 1000;
  let sessionTimer = null;
  let signatureData = '';
  let hasSignature = false;
  let currentDocumentData = null;
  let userSettings = { maxRecords: 10 };
  let emailSettings = { enableEmail: 'non' };

  function encrypt(text) {
    if (!text) return '';
    try {
      return CryptoJS.AES.encrypt(text, 'PremiumVillage2024Key').toString();
    } catch (e) {
      console.error("Encryption error:", e);
      return text;
    }
  }

  function decrypt(text) {
    if (!text) return '';
    try {
      const bytes = CryptoJS.AES.decrypt(text, 'PremiumVillage2024Key');
      return bytes.toString(CryptoJS.enc.Utf8);
    } catch (e) {
      console.error("Decryption error:", e);
      return text;
    }
  }

  function showBanner(type, text){
    const b = document.getElementById('banner');
    b.className = 'banner ' + type;
    b.textContent = text;
    b.classList.remove('hidden');
  }
  
  function hideBanner(){ 
    document.getElementById('banner').classList.add('hidden'); 
  }

  function showInlineMsg(elId, type, text){
    const el = document.getElementById(elId);
    el.textContent = text;
    el.className = 'banner ' + type;
    el.classList.remove('hidden');
  }
  
  function hideInlineMsg(elId){
    const el = document.getElementById(elId);
    el.classList.add('hidden');
  }

  function startSessionTimer(){
    stopSessionTimer();
    sessionTimer = setTimeout(()=>{
      logout(true);
      showBanner('warn', "Session expirée (inactivité). Veuillez vous reconnecter.");
    }, SESSION_TIMEOUT_MS);
  }
  
  function stopSessionTimer(){
    if(sessionTimer){ 
      clearTimeout(sessionTimer); 
      sessionTimer = null; 
    }
  }
  
  function resetSessionTimer(){
    if(currentUser) startSessionTimer();
  }
  
  ['click','keydown','touchstart'].forEach(evt=>{
    document.addEventListener(evt, resetSessionTimer, {passive:true});
  });

  function logout(expired=false){
    currentUser = null;
    stopSessionTimer();
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('userPanel').classList.add('hidden');
    document.getElementById('invitePanel').classList.add('hidden');
    document.getElementById('loginCard').classList.remove('hidden');
    document.getElementById('documentColumn').classList.add('hidden');
    if(!expired) showBanner('info', "Vous êtes déconnecté.");
  }

  async function login(){
    hideInlineMsg('loginMsg');
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();

    if(!u || !p){
      showInlineMsg('loginMsg','err',"Saisissez l'utilisateur et le mot de passe.");
      return;
    }

    const btn = document.getElementById('btnLogin');
    btn.disabled = true;
    btn.textContent = "Connexion...";

    try {
      if(u === 'admin' && p === 'admin'){
        try {
          await firebase.auth().signInWithEmailAndPassword(AUTH_EMAIL, AUTH_PASS);
        } catch (e) {
          console.error("Firebase Auth failed for admin:", e);
        }
        
        currentUser = { role:'admin' };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('documentColumn').classList.remove('hidden');
        showBanner('ok', "Connecté en tant qu'administrateur.");
        startSessionTimer();
        refreshAdmin();
        return;
      }

      await firebase.auth().signInWithEmailAndPassword(AUTH_EMAIL, AUTH_PASS);

      const snapshot = await database.ref('users/' + u).once('value');
      const user = snapshot.val();
      
      if(user && user.pass === p){
        currentUser = { role:'user', id:u, appart:user.appart, bat:user.bat };
        
        const settingsSnapshot = await database.ref('settings/' + u).once('value');
        if(settingsSnapshot.exists()){
          userSettings = settingsSnapshot.val();
          document.getElementById('maxRecords').value = userSettings.maxRecords || 10;
        }
        
        const emailSnapshot = await database.ref('emailSettings/' + u).once('value');
        if(emailSnapshot.exists()){
          emailSettings = emailSnapshot.val();
          document.getElementById('enableEmail').value = emailSettings.enableEmail || 'non';
          toggleEmailFields();
          if(emailSettings.enableEmail === 'oui'){
            document.getElementById('guardEmail').value = decrypt(emailSettings.guardEmail || '');
          }
        }
        
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('userPanel').classList.remove('hidden');
        document.getElementById('documentColumn').classList.remove('hidden');
        showBanner('ok', `Connecté. Appartement ${user.appart} / Immeuble ${user.bat}.`);
        startSessionTimer();
        refreshUser();
      } else {
        showInlineMsg('loginMsg','err',"Identifiants incorrects.");
        await firebase.auth().signOut();
      }
    } catch (error) {
      console.error("Login Error:", error);
      showInlineMsg('loginMsg','err', "Erreur: " + (error.message || "Accès refusé"));
    } finally {
      btn.disabled = false;
      btn.textContent = "Connexion";
    }
  }

  function toggleEmailFields(){
    const enableEmail = document.getElementById('enableEmail').value;
    const emailFields = document.getElementById('emailFields');
    if(enableEmail === 'oui'){
      emailFields.classList.remove('hidden');
    } else {
      emailFields.classList.add('hidden');
    }
  }

  async function saveEmailSettings(){
    const enableEmail = document.getElementById('enableEmail').value;
    
    if(enableEmail === 'oui'){
      const guardEmail = document.getElementById('guardEmail').value.trim();
      
      if(!guardEmail){
        showInlineMsg('emailMsg','warn',"Veuillez entrer l'email du destinataire.");
        return;
      }
      
      if(!guardEmail.includes('@')){
        showInlineMsg('emailMsg','warn',"Veuillez entrer une adresse email valide.");
        return;
      }
      
      emailSettings = {
        enableEmail: enableEmail,
        guardEmail: encrypt(guardEmail)
      };
    } else {
      emailSettings = {
        enableEmail: 'non'
      };
    }
    
    try {
      await database.ref('emailSettings/' + currentUser.id).set(emailSettings);
      showInlineMsg('emailMsg','ok',"Paramètres email enregistrés avec succès.");
    } catch (error) {
      showInlineMsg('emailMsg','err',"Erreur lors de l'enregistrement des paramètres email.");
    }
  }

  async function testEmailSettings(){
    if(emailSettings.enableEmail !== 'oui'){
      showInlineMsg('emailMsg','warn',"Veuillez d'abord activer les notifications par email.");
      return;
    }
    
    const guardEmail = decrypt(emailSettings.guardEmail || '');
    
    if(!guardEmail){
      showInlineMsg('emailMsg','warn',"Veuillez d'abord configurer l'email du destinataire.");
      return;
    }
    
    try {
      emailjs.init("JJkhzg5GLL9ddVV59");
      
      const templateParams = {
        to_email: guardEmail,
        nom: "Test Premium Village",
        date: new Date().toLocaleDateString('fr-FR'),
        appartement: currentUser.appart,
        batiment: currentUser.bat
      };

      const result = await emailjs.send('service_qnnmvxe', 'template_1', templateParams);
      
      if(result.status === 200){
        showInlineMsg('emailMsg','ok',"Email de test envoyé avec succès !");
      } else {
        showInlineMsg('emailMsg','err',"Erreur d'envoi: " + result.text);
      }
    } catch (error) {
      showInlineMsg('emailMsg','err',"Erreur lors de l'envoi du test: " + error);
    }
  }

  async function sendAutomaticEmail(record) {
    if(emailSettings.enableEmail !== 'oui'){
      return { success: true, message: "Emails désactivés" };
    }
    
    const guardEmail = decrypt(emailSettings.guardEmail || '');
    
    if(!guardEmail){
      return { success: false, error: "Email du destinataire non configuré" };
    }
    
    try {
      emailjs.init("JJkhzg5GLL9ddVV59");
      
      const templateParams = {
        to_email: guardEmail,
        nom: