<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Premium Village - Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root{
      --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4; --wa:#25D366;
    }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; color: #2c3e50; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, select, button { font-size:16px; }
    input, select { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:220px; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; opacity:.8; }
    .btn-delete { background: var(--err) !important; }
    .btn-wa { background: var(--wa) !important; margin-left: 5px; }
    .signature-canvas { width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 5px; background: white; cursor: crosshair; }
    .premium-header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
    .email-settings { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 15px; }
    .error-message { color: #d93025; font-size: 14px; margin-top: 5px; display: none; }
    .error-border { border-color: #d93025 !important; }
    .person-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef; }
  </style>
</head>
<body>

<div class="premium-header">
  <h1>Premium Village</h1>
  <p>Gestion des enregistrements des invités</p>
</div>

<div id="banner" class="banner info hidden"></div>

<div id="loginCard" class="card">
  <div class="toolbar">
    <div><strong>Connexion - Premium Village</strong></div>
    <div class="note">Veuillez entrer vos identifiants</div>
  </div>
  <label>Utilisateur</label>
  <input type="text" id="loginUser" placeholder="Identifiant" required />
  <label>Mot de passe</label>
  <input type="password" id="loginPass" placeholder="Mot de passe" required />
  <button id="btnLogin" onclick="login()">Connexion</button>
  <p id="loginMsg" class="banner err hidden"></p>
</div>

<div id="adminPanel" class="hidden">
  <div class="toolbar card">
    <div><strong>Panneau administrateur</strong></div>
    <button onclick="logout()">Déconnexion</button>
  </div>

  <div class="card">
    <div class="toolbar"><strong>Gestion des utilisateurs</strong></div>
    <div class="row">
      <div class="col"><label>Appartement</label><input type="text" id="appartAdmin" placeholder="Ex: 12" /></div>
      <div class="col"><label>Immeuble</label><input type="text" id="batAdmin" placeholder="Ex: A" /></div>
      <div class="col"><label>Mot de passe</label><input type="text" id="passAdmin" placeholder="Mot de passe" /></div>
    </div>
    <button onclick="creerUtilisateur()">Créer utilisateur</button>
  </div>

  <div class="card">
    <div class="toolbar"><strong>Utilisateurs existants</strong></div>
    <table id="tableUsers">
      <thead><tr><th>N°</th><th>Appartement</th><th>Immeuble</th><th>Mot de passe</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <div class="toolbar"><strong>Enregistrements des invités</strong></div>
    <div style="overflow-x:auto;">
      <table id="tableAdmin">
        <thead>
          <tr>
            <th>N°</th><th>Appart.</th><th>Immeuble</th><th>Nom</th><th>Nb Pers.</th><th>Date</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="userPanel" class="hidden">
  <div class="toolbar card">
    <div><strong>Mon espace</strong></div>
    <button onclick="logout()">Déconnexion</button>
  </div>

  <div class="card">
    <div class="toolbar"><strong>Paramètres Email (EmailJS)</strong></div>
    <div class="email-settings">
      <p class="note">Utilisez EmailJS pour envoyer des notifications sans script externe.</p>
      <label>Service ID</label><input type="text" id="ejsService" placeholder="service_xxx" />
      <label>Template ID</label><input type="text" id="ejsTemplate" placeholder="template_xxx" />
      <label>Public Key</label><input type="text" id="ejsPublic" placeholder="user_xxx" />
      <label>Email du destinataire</label><input type="email" id="guardEmail" placeholder="destinataire@email.com" />
      <button onclick="saveEmailSettings()">Enregistrer les paramètres</button>
      <p id="emailMsg" class="banner hidden"></p>
    </div>
  </div>

  <div class="card">
    <div class="toolbar"><strong>Mes enregistrements</strong></div>
    <div style="overflow-x:auto;">
      <table id="tableUserRecords">
        <thead>
          <tr><th>N°</th><th>Nom</th><th>Nb Pers.</th><th>Date</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="invitePanel" class="hidden">
  <div class="card">
    <h3>Enregistrement Invité</h3>
    <div id="guestForm">
      <div class="row">
        <div class="col"><label>Appartement</label><input type="text" id="invAppart" readonly /></div>
        <div class="col"><label>Immeuble</label><input type="text" id="invBat" readonly /></div>
      </div>
      <label>Date d'arrivée *</label><input type="date" id="dateArrivee" required />
      <label>Nombre des invités *</label><input type="number" id="nbPers" value="1" min="1" onchange="genererChamps()" />
      
      <div class="person-group">
        <h4>Personne principale</h4>
        <label>Nom et Prénom *</label><input type="text" id="nomPrincipal" placeholder="Nom complet" required />
        <label>Type de document *</label>
        <select id="typeDocPrincipal">
          <option value="">Sélectionner</option>
          <option value="Passeport">Passeport</option>
          <option value="Carte d'identité">Carte d'identité</option>
        </select>
        <label>Numéro de document *</label><input type="text" id="docPrincipal" placeholder="N° de document" required />
      </div>

      <div id="personnes"></div>

      <label>Signature *</label>
      <canvas id="signatureCanvas" class="signature-canvas"></canvas>
      <button onclick="clearCanvas()">Effacer</button>
      
      <div style="margin-top:15px;">
        <input type="checkbox" id="acceptCheckbox" style="width:auto; margin-right:10px;">
        <label style="display:inline;">J'accepte le règlement intérieur.</label>
      </div>
      
      <button id="registerBtn" onclick="registerSignature()" style="width:100%; background:var(--ok);">Enregistrer et valider</button>
    </div>
    <div id="successMessage" class="hidden banner ok">
      Enregistrement réussi ! Votre document PDF a été généré.
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const firebaseConfig = {
    databaseURL: "https://premium-village-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const AUTH_EMAIL = "admin@premium.com";
  const AUTH_PASS = "premium123";

  let currentUser = null;
  let emailSettings = {};
  let hasSignature = false;

  // --- AUTH ---
  async function login(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    if(u === 'admin' && p === 'admin'){
      currentUser = { role:'admin' };
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      refreshAdmin();
      return;
    }
    try {
      await firebase.auth().signInWithEmailAndPassword(AUTH_EMAIL, AUTH_PASS);
      const snap = await database.ref('users/' + u).once('value');
      const user = snap.val();
      if(user && user.pass === p){
        currentUser = { role:'user', id:u, appart:user.appart, bat:user.bat };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('userPanel').classList.remove('hidden');
        loadEmailSettings();
        refreshUser();
      } else {
        alert("Identifiants incorrects");
      }
    } catch(e) { alert("Erreur: " + e.message); }
  }

  function logout(){
    currentUser = null;
    location.reload();
  }

  // --- ADMIN ---
  async function creerUtilisateur(){
    const app = document.getElementById('appartAdmin').value.trim();
    const bat = document.getElementById('batAdmin').value.trim();
    const pass = document.getElementById('passAdmin').value.trim();
    if(!app || !bat || !pass) return;
    await database.ref('users/' + app + bat).set({ appart:app, bat:bat, pass:pass });
    refreshAdmin();
  }

  async function refreshAdmin(){
    const snapUsers = await database.ref('users').once('value');
    const tbodyUsers = document.querySelector('#tableUsers tbody');
    tbodyUsers.innerHTML = '';
    let i = 1;
    snapUsers.forEach(u => {
      const user = u.val();
      tbodyUsers.innerHTML += `<tr><td>${i++}</td><td>${user.appart}</td><td>${user.bat}</td><td>${user.pass}</td>
        <td><button class="btn-delete" onclick="deleteUser('${u.key}')">Supprimer</button></td></tr>`;
    });

    const snapRecs = await database.ref('records').once('value');
    const tbodyRecs = document.querySelector('#tableAdmin tbody');
    tbodyRecs.innerHTML = '';
    let j = 1;
    snapRecs.forEach(r => {
      const rec = r.val();
      tbodyRecs.innerHTML += `<tr><td>${j++}</td><td>${rec.appart}</td><td>${rec.bat}</td><td>${rec.nom}</td><td>${rec.nb}</td><td>${rec.date}</td>
        <td>
          <button class="btn-wa" onclick="sendWA('${r.key}')">WhatsApp</button>
          <button class="btn-delete" onclick="deleteRecord('${r.key}')">Supprimer</button>
        </td></tr>`;
    });
  }

  async function deleteUser(id){ if(confirm("Supprimer?")) { await database.ref('users/'+id).remove(); refreshAdmin(); } }
  async function deleteRecord(id){ if(confirm("Supprimer?")) { await database.ref('records/'+id).remove(); refreshAdmin(); } }

  // --- USER ---
  async function loadEmailSettings(){
    const snap = await database.ref('emailSettings/' + currentUser.id).once('value');
    if(snap.exists()){
      emailSettings = snap.val();
      document.getElementById('ejsService').value = emailSettings.service || '';
      document.getElementById('ejsTemplate').value = emailSettings.template || '';
      document.getElementById('ejsPublic').value = emailSettings.public || '';
      document.getElementById('guardEmail').value = emailSettings.to || '';
    }
  }

  async function saveEmailSettings(){
    emailSettings = {
      service: document.getElementById('ejsService').value.trim(),
      template: document.getElementById('ejsTemplate').value.trim(),
      public: document.getElementById('ejsPublic').value.trim(),
      to: document.getElementById('guardEmail').value.trim()
    };
    await database.ref('emailSettings/' + currentUser.id).set(emailSettings);
    alert("Paramètres enregistrés");
  }

  async function refreshUser(){
    const snap = await database.ref('records').orderByChild('appart').equalTo(currentUser.appart).once('value');
    const tbody = document.querySelector('#tableUserRecords tbody');
    tbody.innerHTML = '';
    let i = 1;
    snap.forEach(r => {
      const rec = r.val();
      if(rec.bat === currentUser.bat){
        tbody.innerHTML += `<tr><td>${i++}</td><td>${rec.nom}</td><td>${rec.nb}</td><td>${rec.date}</td>
          <td><button class="btn-wa" onclick="sendWA('${r.key}')">WhatsApp</button></td></tr>`;
      }
    });
  }

  // --- WHATSAPP ---
  async function sendWA(id){
    const snap = await database.ref('records/' + id).once('value');
    const r = snap.val();
    const others = r.personnes ? Object.values(r.personnes).map((p, idx) => `${idx+1}. ${p.nom} - ${p.doc}`).join('\n') : 'Aucun';
    
    const msg = `Salam :
      
Arrivée: ${r.date}
Appartement: ${r.appart}
Imm: ${r.bat}
Nombre de personnes: ${r.nb} personnes

Réservation au nom de:
Nom et Prénom: ${r.nom}
Numéro de document: ${r.doc}

Autres personnes:
${others}

NB : Svp pas d'autres personnes autorisées seul Les personnes figurent dans la réservation.

Merci
------------------------------------------
السلام عليكم:

الوصول: ${r.date}
الشقة: ${r.appart}
رقم العمارة: ${r.bat}
عدد الأشخاص: ${r.nb} أشخاص

الحجز باسم:
الإسم و اللقب: ${r.nom}
رقم جواز السفر: ${r.doc}

أشخاص آخرون:
${others}

ملاحظة: الرجاء عدم السماح لأي أشخاص آخرين، فقط الأشخاص المذكورين في الحجز.

شكرًا.`;

    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  }

  // --- INVITE ---
  function genererChamps(){
    const nb = parseInt(document.getElementById('nbPers').value) || 1;
    const cont = document.getElementById('personnes');
    cont.innerHTML = '';
    for(let i=2; i<=nb; i++){
      cont.innerHTML += `<div class="person-group">
        <h4>Personne ${i}</h4>
        <label>Nom & Prénom *</label><input type="text" id="pers${i}Nom" required />
        <label>Type de document *</label>
        <select id="pers${i}TypeDoc"><option value="Passeport">Passeport</option><option value="Carte d'identité">Carte d'identité</option></select>
        <label>Numéro de document *</label><input type="text" id="pers${i}Doc" required />
      </div>`;
    }
  }

  // --- SIGNATURE ---
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  canvas.addEventListener('mousedown', () => drawing = true);
  canvas.addEventListener('mouseup', () => { drawing = false; hasSignature = true; });
  canvas.addEventListener('mousemove', (e) => {
    if(!drawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  });
  function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.beginPath(); hasSignature = false; }

  // --- REGISTER ---
  async function registerSignature(){
    if(!hasSignature || !document.getElementById('acceptCheckbox').checked) { alert("Signature et acceptation requises"); return; }
    const rec = {
      appart: document.getElementById('invAppart').value,
      bat: document.getElementById('invBat').value,
      date: document.getElementById('dateArrivee').value,
      nb: document.getElementById('nbPers').value,
      nom: document.getElementById('nomPrincipal').value,
      doc: document.getElementById('docPrincipal').value,
      personnes: {}
    };
    const nb = parseInt(rec.nb);
    for(let i=2; i<=nb; i++){
      rec.personnes['p'+i] = {
        nom: document.getElementById('pers'+i+'Nom').value,
        doc: document.getElementById('pers'+i+'Doc').value
      };
    }

    const newRef = database.ref('records').push();
    await newRef.set(rec);
    
    // EmailJS Notification
    if(emailSettings.public){
      emailjs.init(emailSettings.public);
      emailjs.send(emailSettings.service, emailSettings.template, {
        to_email: emailSettings.to,
        guest_name: rec.nom,
        appart: rec.appart,
        date: rec.date
      });
    }

    document.getElementById('guestForm').classList.add('hidden');
    document.getElementById('successMessage').classList.remove('hidden');
    alert("Enregistré avec succès !");
  }

  // --- INIT ---
  window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const inviteId = urlParams.get('invite');
    if(inviteId) enterInviteMode(inviteId);
  };

  async function enterInviteMode(id){
    await firebase.auth().signInWithEmailAndPassword(AUTH_EMAIL, AUTH_PASS);
    const snap = await database.ref('users/' + id).once('value');
    const u = snap.val();
    if(u){
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('invitePanel').classList.remove('hidden');
      document.getElementById('invAppart').value = u.appart;
      document.getElementById('invBat').value = u.bat;
      // Charger settings email pour notif
      const eSnap = await database.ref('emailSettings/' + id).once('value');
      if(eSnap.exists()) emailSettings = eSnap.val();
    }
  }
</script>
</body>
</html>
