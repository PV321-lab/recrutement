```html
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root{
      --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4;
    }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, select, button { font-size:16px; }
    input, select { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:220px; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; opacity:.8; }
    .recap{ background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:8px; min-width:240px; }
    .person-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef; }
    .person-group h4 { margin: 0 0 10px 0; color: #1E40AF; }
    .consent-container { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; }
    .consent-text { max-height: 150px; overflow-y: auto; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ced4da; margin: 10px 0; }
    .btn-delete { background: var(--err) !important; margin-left: 5px; }
    .signature-area { margin: 40px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
    .signature-title { font-size: 18px; margin-bottom: 20px; color: #2c3e50; }
    .signature-canvas { width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 5px; background: white; cursor: crosshair; margin-bottom: 20px; }
    .doc-type-row { display: flex; gap: 10px; }
    .doc-type-row .col { flex: 1; }
    .rules-container { 
      margin: 20px 0; 
      padding: 15px; 
      background: #f8f9fa; 
      border-radius: 8px; 
      border: 1px solid #dee2e6;
      max-height: 250px;
      overflow-y: auto;
    }
    .rules-container h4 { margin-top: 0; color: #2c3e50; }
    .rules-container ul { padding-left: 20px; margin: 10px 0; }
    .rules-container li { margin-bottom: 8px; }
    .signature-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .document-column { 
      border-left: 2px solid #007bff; 
      padding-left: 20px; 
      min-height: 100vh;
      background: #f9f9f9;
    }
    .document-preview { 
      background: white; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    .doc-title { 
      text-align: center; 
      font-size: 24px; 
      font-weight: bold; 
      color: #2c3e50; 
      margin-bottom: 30px; 
      border-bottom: 2px solid #2c3e50; 
      padding-bottom: 10px;
    }
    .doc-info { margin-bottom: 20px; }
    .doc-info p { margin: 5px 0; }
    .doc-section { margin-bottom: 30px; }
    .doc-section-title { 
      font-size: 18px; 
      font-weight: bold; 
      color: #2c3e50; 
      margin-bottom: 10px; 
      border-bottom: 1px solid #ddd; 
      padding-bottom: 5px;
    }
    .doc-signature { 
      text-align: center; 
      margin-top: 40px; 
      padding-top: 20px; 
      border-top: 2px solid #2c3e50;
    }
    .doc-signature-box { 
      border: 1px solid #000; 
      height: 100px; 
      margin: 20px auto; 
      width: 300px; 
      position: relative;
    }
    .doc-signature-text { 
      position: absolute; 
      bottom: 5px; 
      left: 0; 
      right: 0; 
      text-align: center; 
      font-size: 12px; 
      color: #666;
    }
    .two-column-layout {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .form-column {
      flex: 2;
      min-width: 300px;
    }
    .document-column {
      flex: 1;
      min-width: 300px;
    }
    .doc-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .nationality-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .nationality-row .col {
      flex: 1;
    }
  </style>
</head>
<body>

<h2>Enregistrement des invités</h2>

<div class="two-column-layout">
  <div class="form-column">
    <div id="banner" class="banner info hidden"></div>

    <div id="loginCard" class="card">
      <div class="toolbar">
        <div><strong>Connexion</strong></div>
        <div class="note">Veuillez entrer vos identifiants</div>
      </div>
      <label>Utilisateur</label>
      <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required />
      <label>Mot de passe</label>
      <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required />
      <button id="btnLogin" onclick="login()">Connexion</button>
      <p id="loginMsg" class="banner err hidden"></p>
    </div>

    <div id="adminPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Panneau administrateur</strong></div>
        <div>
          <button onclick="logout()">Déconnexion</button>
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Gestion des utilisateurs</strong></div>
        </div>
        <div class="row">
          <div class="col">
            <label>Appartement</label>
            <input type="text" id="appartAdmin" placeholder="Ex: 12" />
          </div>
          <div class="col">
            <label>Immeuble</label>
            <input type="text" id="batAdmin" placeholder="Ex: A" />
          </div>
          <div class="col">
            <label>Mot de passe</label>
            <input type="text" id="passAdmin" placeholder="Mot de passe" />
          </div>
        </div>
        <button onclick="creerUtilisateur()">Créer utilisateur</button>
        <p id="userWarn" class="banner warn hidden"></p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Utilisateurs existants</strong></div>
        </div>
        <table id="tableUsers">
          <thead>
            <tr><th>N°</th><th>Appartement</th><th>Immeuble</th><th>Mot de passe</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Enregistrements des invités</strong></div>
        </div>
        <table id="tableAdmin">
          <thead>
            <tr>
              <th>N°</th><th>Appart.</th><th>Immeuble</th><th>Nom</th><th>Document</th><th>Type Doc</th><th>Nationalité</th>
              <th>Nb Pers.</th><th>Personnes</th><th>Date</th><th>Document</th><th>Action</th><th>Statut</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="userPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Mon espace</strong></div>
        <div><button onclick="logout()">Déconnexion</button></div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Générer un lien d'invitation</strong></div>
        </div>
        <button onclick="genererLien()">Générer le lien</button>
        <p id="lienInvite"></p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div><strong>Mes enregistrements</strong></div>
        </div>
        <table id="tableUser">
          <thead>
            <tr>
              <th>N°</th><th>Nom</th><th>Document</th><th>Type Doc</th><th>Nationalité</th><th>Nb Pers.</th><th>Personnes</th><th>Date</th><th>Document</th><th>Statut</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="invitePanel" class="hidden">
      <div class="guest-form-container">
        <div class="toolbar" style="margin-bottom: 20px;">
          <h3 style="margin: 0; flex-grow: 1;">Enregistrement Invité</h3>
        </div>

        <div class="card">
          <form id="guestForm">
            <div class="row">
              <div class="col">
                <label>Appartement</label>
                <input type="text" id="invAppart" readonly />
              </div>
              <div class="col">
                <label>Immeuble</label>
                <input type="text" id="invBat" readonly />
              </div>
            </div>

            <label>Date d'arrivée *</label>
            <input type="date" id="dateArrivee" required class="guest-input" />

            <label>Nombre des invités *</label>
            <input type="number" id="nbPers" min="1" value="1" onchange="genererChamps()" required class="guest-input" />

            <label>Nom et Prénom de la personne principale *</label>
            <input type="text" id="nomPrincipal" required placeholder="Nom complet" class="guest-input" />

            <div class="row doc-type-row">
              <div class="col">
                <label>Type de document *</label>
                <select id="typeDocPrincipal" required class="guest-input">
                  <option value="">Sélectionner</option>
                  <option value="Passeport">Passeport</option>
                  <option value="Carte d'identité">Carte d'identité</option>
                </select>
              </div>
              <div class="col">
                <label>Numéro de document *</label>
                <input type="text" id="docPrincipal" required placeholder="N° de document" class="guest-input" />
              </div>
            </div>

            <div class="nationality-row">
              <div class="col">
                <label>Nationalité *</label>
                <select id="nationalitePrincipal" required class="guest-input">
                  <option value="">Sélectionner</option>
                  <option value="Marocaine">Marocaine</option>
                  <option value="Française">Française</option>
                  <option value="Espagnole">Espagnole</option>
                  <option value="Portugaise">Portugaise</option>
                  <option value="Allemande">Allemande</option>
                  <option value="Italienne">Italienne</option>
                  <option value="Belge">Belge</option>
                  <option value="Néerlandaise">Néerlandaise</option>
                  <option value="Britannique">Britannique</option>
                  <option value="Américaine">Américaine</option>
                  <option value="Canadienne">Canadienne</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
            </div>

            <div id="personnes"></div>

            <div class="consent-container">
              <h4>Consentement à la collecte de données</h4>
              <div class="consent-text">
                <p>En acceptant, vous consentez à la collecte de vos informations personnelles. Conformément à la législation marocaine, ces données seront conservées temporairement et supprimées une fois leur utilisation terminée.</p>
              </div>
              <label style="display: flex; align-items: center; margin-top: 10px;">
                <input type="checkbox" id="consentCheckbox" required style="margin-right: 10px; width: auto;">
                <span>J'accepte les conditions de traitement des données</span>
              </label>
            </div>

            <div class="rules-container">
              <h4>Règlement intérieur à respecter :</h4>
              <ul>
                <li><strong>1. Couples marocains :</strong> Seuls les couples de la nationalité marocaine mariés sont acceptés.</li>
                <li><strong>2. Tranquillité et bruit :</strong> Silence total obligatoire après 23h00. Pas de musique forte, cris ou nuisances sonores à toute heure.</li>
                <li><strong>3. Tabagisme :</strong> Fumer est strictement interdit à l'intérieur. Autorisé uniquement en extérieur (terrasse ou jardin), avec obligation de nettoyer les mégots et cendres.</li>
                <li><strong>4. Nombre de personnes :</strong> Maximum 5 personnes autorisées dans l'appartement.</li>
                <li><strong>5. Piscine :</strong> Douche obligatoire avant la baignade. Pas de verre ni objets fragiles autour de la piscine. Surveillance permanente des enfants par un adulte. Horaires : fermeture à 20h00. Pas de courses ni plongeons.</li>
                <li><strong>6. Propreté et entretien :</strong> Maintenir les lieux propres en permanence. Vider régulièrement les poubelles. Respecter les sols et surfaces (pas de traces, pas de nourriture hors cuisine).</li>
              </ul>
              <p style="margin-top: 15px; font-weight: bold; color: #2c3e50;">
                En acceptant ce règlement, vous confirmez avoir lu et compris ces règles.
                <br>J'accepte l'ensemble des règles ci-dessus.
              </p>
            </div>

            <div class="signature-area">
              <div class="signature-title">Signature du règlement intérieur</div>
              <canvas id="signatureCanvas" class="signature-canvas">
                Votre navigateur ne supporte pas la signature.
              </canvas>
              <div class="signature-controls">
                <button type="button" id="clearBtn" class="btn" style="background: #e74c3c;">Effacer la signature</button>
                <button type="button" id="registerBtn" class="btn" style="background: #27ae60;" disabled>Enregistrer</button>
              </div>
              <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Signez ci-dessus pour accepter le règlement intérieur et enregistrer votre réservation.
              </p>
            </div>
          </form>
        </div>

        <div id="successMessage" class="banner ok hidden">
          Enregistrement réussi ! Un onglet s'ouvre avec votre document PDF.
          <br><br>
          <strong>Note importante :</strong> En cas de demande des agents de sécurité, présentez ce document signé.
          Seules les personnes enregistrées dans cette réservation sont autorisées à entrer.
        </div>
      </div>
    </div>
  </div>

  <div id="documentColumn" class="document-column hidden">
    <div class="card">
      <h3>Document Signé</h3>
      <div id="documentPreview" class="document-preview">
        <p>Sélectionnez un enregistrement pour voir le document.</p>
      </div>
      <div id="docActions" class="doc-actions hidden">
        <button id="downloadDocBtn" onclick="downloadCurrentDocument()">Télécharger PDF</button>
        <button id="viewDocBtn" onclick="viewCurrentDocument()">Ouvrir dans un nouvel onglet</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const firebaseConfig = {
    databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let currentUser = null;
  const SESSION_TIMEOUT_MS = 10 * 60 * 1000;
  let sessionTimer = null;
  let signatureData = '';
  let hasSignature = false;
  let currentDocumentData = null;

  function showBanner(type, text){
    const b = document.getElementById('banner');
    b.className = 'banner ' + type;
    b.textContent = text;
    b.classList.remove('hidden');
  }
  
  function hideBanner(){ 
    document.getElementById('banner').classList.add('hidden'); 
  }

  function showInlineMsg(elId, type, text){
    const el = document.getElementById(elId);
    el.textContent = text;
    el.className = 'banner ' + type;
    el.classList.remove('hidden');
  }
  
  function hideInlineMsg(elId){
    const el = document.getElementById(elId);
    el.classList.add('hidden');
  }

  function startSessionTimer(){
    stopSessionTimer();
    sessionTimer = setTimeout(()=>{
      logout(true);
      showBanner('warn', "Session expirée (inactivité). Veuillez vous reconnecter.");
    }, SESSION_TIMEOUT_MS);
  }
  
  function stopSessionTimer(){
    if(sessionTimer){ 
      clearTimeout(sessionTimer); 
      sessionTimer = null; 
    }
  }
  
  function resetSessionTimer(){
    if(currentUser) startSessionTimer();
  }
  
  ['click','keydown','touchstart'].forEach(evt=>{
    document.addEventListener(evt, resetSessionTimer, {passive:true});
  });

  function logout(expired=false){
    currentUser = null;
    stopSessionTimer();
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('userPanel').classList.add('hidden');
    document.getElementById('invitePanel').classList.add('hidden');
    document.getElementById('loginCard').classList.remove('hidden');
    document.getElementById('documentColumn').classList.add('hidden');
    if(!expired) showBanner('info', "Vous êtes déconnecté.");
  }

  async function login(){
    hideInlineMsg('loginMsg');
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();

    if(!u || !p){
      showInlineMsg('loginMsg','err',"Saisissez l'utilisateur et le mot de passe.");
      return;
    }

    if(u === 'admin' && p === 'admin'){
      currentUser = { role:'admin' };
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('documentColumn').classList.remove('hidden');
      showBanner('ok', "Connecté en tant qu'administrateur.");
      startSessionTimer();
      refreshAdmin();
      return;
    }

    try {
      const snapshot = await database.ref('users/' + u).once('value');
      const user = snapshot.val();
      
      if(user && user.pass === p){
        currentUser = { role:'user', id:u, appart:user.appart, bat:user.bat };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('userPanel').classList.remove('hidden');
        document.getElementById('documentColumn').classList.remove('hidden');
        showBanner('ok', `Connecté. Appartement ${user.appart} / Immeuble ${user.bat}.`);
        startSessionTimer();
        refreshUser();
      } else {
        showInlineMsg('loginMsg','err',"Identifiants incorrects.");
      }
    } catch (error) {
      showInlineMsg('loginMsg','err',"Erreur d'accès à la base de données.");
    }
  }

  async function creerUtilisateur(){
    hideInlineMsg('userWarn');
    const appart = (document.getElementById('appartAdmin').value || '').trim();
    const bat = (document.getElementById('batAdmin').value || '').trim();
    const pass = (document.getElementById('passAdmin').value || '').trim();
    
    if(!appart || !bat || !pass){
      showInlineMsg('userWarn','warn',"Tous les champs utilisateur sont obligatoires.");
      return;
    }
    
    const userId = appart + bat;
    
    try {
      const snapshot = await database.ref('users/' + userId).once('value');
      
      if(snapshot.exists()){
        showInlineMsg('userWarn','warn',`L'utilisateur ${userId} existe déjà.`);
      } else {
        await database.ref('users/' + userId).set({
          user: userId,
          appart: appart,
          bat: bat,
          pass: pass
        });
        
        showBanner('ok', `Utilisateur ${userId} créé.`);
        refreshAdmin();
      }
    } catch (error) {
      showInlineMsg('userWarn','err',"Erreur lors de la création de l'utilisateur.");
    }
  }

  async function refreshAdmin(){
    const tbodyU = document.querySelector('#tableUsers tbody');
    tbodyU.innerHTML = '';
    
    try {
      const usersSnapshot = await database.ref('users').once('value');
      const users = usersSnapshot.val() || {};
      
      let counter = 1;
      Object.values(users).forEach(u => {
        tbodyU.insertAdjacentHTML('beforeend',
          `<tr><td>${counter++}</td><td>${u.appart}</td><td>${u.bat}</td><td>${u.pass}</td></tr>`);
      });
    } catch (error) {
      showBanner('err', "Erreur lors du chargement des utilisateurs.");
    }

    const tbody = document.querySelector('#tableAdmin tbody');
    tbody.innerHTML = '';
    
    try {
      const recordsSnapshot = await database.ref('records').once('value');
      const records = recordsSnapshot.val() || {};
      
      let counter = 1;
      Object.entries(records).slice(-200).forEach(([id, r]) => {
        const personnesList = r.personnes ? Object.values(r.personnes).map(p => `${p.nom} (${p.typeDoc}) - ${p.doc}`).join(', ') : '';
        const sendBtn = `<button onclick="envoyerWhatsApp('${id}')">Envoyer</button>`;
        const viewBtn = `<button onclick="afficherDocument('${id}')">Voir doc</button>`;
        
        tbody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${counter++}</td>
            <td>${r.appart}</td>
            <td>${r.bat}</td>
            <td>${r.nom}</td>
            <td>${r.doc}</td>
            <td>${r.typeDoc || 'Non spécifié'}</td>
            <td>${r.nationalite || 'Non spécifié'}</td>
            <td>${r.personnes ? Object.keys(r.personnes).length + 1 : 1}</td>
            <td>${personnesList}</td>
            <td>${r.date}</td>
            <td>${viewBtn}</td>
            <td>${sendBtn}</td>
            <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
          </tr>`);
      });
    } catch (error) {
      showBanner('err', "Erreur lors du chargement des enregistrements.");
    }
  }

  async function refreshUser(){
    const tbody = document.querySelector('#tableUser tbody');
    tbody.innerHTML = '';
    
    try {
      const recordsSnapshot = await database.ref('records').once('value');
      const records = recordsSnapshot.val() || {};
      
      let counter = 1;
      Object.entries(records)
        .filter(([id, r]) => r.appart === currentUser.appart && r.bat === currentUser.bat)
        .slice(-200)
        .forEach(([id, r]) => {
          const personnesList = r.personnes ? Object.values(r.personnes).map(p => `${p.nom} (${p.typeDoc}) - ${p.doc}`).join(', ') : '';
          const sendBtn = `<button onclick="envoyerWhatsApp('${id}')">Envoyer</button>`;
          const viewBtn = `<button onclick="afficherDocument('${id}')">Voir doc</button>`;
          const deleteBtn = `<button class="btn-delete" onclick="supprimerEnregistrement('${id}')">Supprimer</button>`;
          
          tbody.insertAdjacentHTML('beforeend',
            `<tr>
              <td>${counter++}</td>
              <td>${r.nom}</td>
              <td>${r.doc}</td>
              <td>${r.typeDoc || 'Non spécifié'}</td>
              <td>${r.nationalite || 'Non spécifié'}</td>
              <td>${r.personnes ? Object.keys(r.personnes).length + 1 : 1}</td>
              <td>${personnesList}</td>
              <td>${r.date}</td>
              <td>${viewBtn}</td>
              <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
              <td>${sendBtn}${deleteBtn}</td>
            </tr>`);
        });
    } catch (error) {
      showBanner('err', "Erreur de lecture des enregistrements.");
    }
  }

  async function supprimerEnregistrement(id) {
    if (!confirm("Êtes-vous sûr de vouloir supprimer cet enregistrement ?")) {
      return;
    }
    
    try {
      await database.ref('records/' + id).remove();
      await database.ref('documents/' + id).remove();
      showBanner('ok', "Enregistrement et document supprimés avec succès.");
      refreshUser();
      document.getElementById('documentPreview').innerHTML = '<p>Sélectionnez un enregistrement pour voir le document.</p>';
      document.getElementById('docActions').classList.add('hidden');
    } catch (error) {
      showBanner('err', "Erreur lors de la suppression de l'enregistrement.");
    }
  }

  function genererLien(){
    const base = location.href.split('?')[0];
    const lien = `${base}?invite=${encodeURIComponent(currentUser.id)}`;
    const p = document.getElementById('lienInvite');
    p.innerHTML = `Lien pour vos invités : <a href="${lien}" target="_blank">${lien}</a>`;
    showBanner('info', "Copiez/partagez ce lien avec vos invités.");
  }

  const canvas = document.getElementById('signatureCanvas');
  const clearBtn = document.getElementById('clearBtn');
  const registerBtn = document.getElementById('registerBtn');
  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  const { jsPDF } = window.jspdf;

  function initCanvas() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    if (!hasSignature) {
      clearCanvas();
    }
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
    registerBtn.disabled = true;
  }

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    let x, y;
    
    if (e.type.includes('touch')) {
      const touch = e.touches[0] || e.changedTouches[0];
      x = touch.clientX - rect.left;
      y = touch.clientY - rect.top;
    } else {
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }
    
    return { x, y };
  }

  function startDraw(e) {
    isDrawing = true;
    const pos = getPos(e);
    [lastX, lastY] = [pos.x, pos.y];
    
    ctx.beginPath();
    ctx.arc(lastX, lastY, ctx.lineWidth/2, 0, Math.PI*2);
    ctx.fill();
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const pos = getPos(e);
    const currentX = pos.x;
    const currentY = pos.y;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(currentX, currentY);
    ctx.stroke();
    
    [lastX, lastY] = [currentX, currentY];
  }

  function stopDraw() {
    if (!isDrawing) return;
    isDrawing = false;
    hasSignature = true;
    registerBtn.disabled = false;
  }

  async function registerSignature() {
    if(!document.getElementById('consentCheckbox').checked){
      showBanner('warn', "Veuillez accepter les conditions de traitement des données.");
      return;
    }

    if(!hasSignature){
      showBanner('warn', "Veuillez d'abord signer le règlement.");
      return;
    }

    const nom = (document.getElementById('nomPrincipal').value || '').trim();
    const doc = (document.getElementById('docPrincipal').value || '').trim();
    const typeDoc = (document.getElementById('typeDocPrincipal').value || '').trim();
    const nationalite = (document.getElementById('nationalitePrincipal').value || '').trim();
    const nb = parseInt(document.getElementById('nbPers').value || '0', 10);
    const date = document.getElementById('dateArrivee').value;

    if(!nom || !doc || !typeDoc || !nationalite || !date || !Number.isInteger(nb) || nb < 1){
      showBanner('warn',"Tous les champs sont obligatoires.");
      return;
    }

    const personnes = {};
    for(let i=2; i<=nb; i++){
      const nomVal = (document.getElementById(`pers${i}Nom`)?.value || '').trim();
      const docVal = (document.getElementById(`pers${i}Doc`)?.value || '').trim();
      const typeDocVal = (document.getElementById(`pers${i}TypeDoc`)?.value || '').trim();
      const nationaliteVal = (document.getElementById(`pers${i}Nationalite`)?.value || '').trim();
      
      if(!nomVal || !docVal || !typeDocVal || !nationaliteVal){
        showBanner('warn',`Merci de renseigner tous les champs pour la personne ${i}.`);
        return;
      }
      
      personnes[`pers${i-1}`] = { nom: nomVal, doc: docVal, typeDoc: typeDocVal, nationalite: nationaliteVal };
    }

    const appart = document.getElementById('invAppart').value;
    const bat = document.getElementById('invBat').value;

    signatureData = canvas.toDataURL('image/png');

    const rec = { 
      appart, 
      bat, 
      nom, 
      doc, 
      typeDoc,
      nationalite,
      personnes, 
      date, 
      sent:false,
      signature: signatureData,
      timestamp: Date.now()
    };

    try {
      registerBtn.disabled = true;
      registerBtn.textContent = '⏳ Enregistrement...';

      const newRecordRef = database.ref('records').push();
      await newRecordRef.set(rec);
      
      const id = newRecordRef.key;
      rec.id = id;
      
      const documentData = generateDocumentHTML(rec);
      await database.ref('documents/' + id).set({
        html: documentData,
        recordId: id,
        appart: appart,
        bat: bat,
        nom: nom,
        date: rec.date,
        signature: signatureData,
        timestamp: Date.now()
      });
      
      document.getElementById('successMessage').classList.remove('hidden');
      document.getElementById('guestForm').style.display = 'none';

      generateAndOpenPDF(rec);
      
      registerBtn.textContent = 'Enregistrer';
      registerBtn.disabled = false;
      
    } catch (error) {
      showBanner('err',"Erreur lors de l'enregistrement. Réessayez.");
      registerBtn.textContent = 'Enregistrer';
      registerBtn.disabled = false;
    }
  }

  function setupSignatureEvents() {
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startDraw(e);
    });
    
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      draw(e);
    });
    
    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      stopDraw();
    });
    
    clearBtn.addEventListener('click', clearCanvas);
    registerBtn.addEventListener('click', registerSignature);
    window.addEventListener('resize', initCanvas);
  }

  async function enterInviteMode(userId){
    try {
      const snapshot = await database.ref('users/' + userId).once('value');
      const user = snapshot.val();
      
      if(!user){
        showBanner('err',"Lien invalide ou utilisateur introuvable.");
        return;
      }
      
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('invitePanel').classList.remove('hidden');
      document.getElementById('invAppart').value = user.appart;
      document.getElementById('invBat').value = user.bat;
      genererChamps();
      initCanvas();
      setupSignatureEvents();
      hideBanner();
      
    } catch (error) {
      showBanner('err', "Erreur lors du chargement des données utilisateur.");
    }
  }

  function genererChamps(){
    const nb = Math.max(1, parseInt(document.getElementById('nbPers').value || '1', 10));
    const cont = document.getElementById('personnes');
    cont.innerHTML = '';
    
    for(let i=2; i<=nb; i++){
      const group = document.createElement('div');
      group.className = 'person-group';
      
      const title = document.createElement('h4');
      title.textContent = `Personne ${i}`;
      title.style.marginBottom = '10px';
      title.style.fontWeight = 'bold';
      group.appendChild(title);
      
      const nomLab = document.createElement('label');
      nomLab.textContent = 'Nom & Prénom';
      group.appendChild(nomLab);
      
      const nomInp = document.createElement('input');
      nomInp.type = 'text';
      nomInp.id = `pers${i}Nom`;
      nomInp.required = true;
      nomInp.className = 'guest-input';
      nomInp.placeholder = `Nom complet personne ${i}`;
      group.appendChild(nomInp);
      
      const docTypeLab = document.createElement('label');
      docTypeLab.textContent = 'Type de document';
      docTypeLab.style.marginTop = '10px';
      group.appendChild(docTypeLab);
      
      const docTypeInp = document.createElement('select');
      docTypeInp.id = `pers${i}TypeDoc`;
      docTypeInp.required = true;
      docTypeInp.className = 'guest-input';
      docTypeInp.innerHTML = `
        <option value="">Sélectionner</option>
        <option value="Passeport">Passeport</option>
        <option value="Carte d'identité">Carte d'identité</option>
      `;
      group.appendChild(docTypeInp);
      
      const docLab = document.createElement('label');
      docLab.textContent = 'Numéro de document';
      docLab.style.marginTop = '10px';
      group.appendChild(docLab);
      
      const docInp = document.createElement('input');
      docInp.type = 'text';
      docInp.id = `pers${i}Doc`;
      docInp.required = true;
      docInp.className = 'guest-input';
      docInp.placeholder = `Document personne ${i}`;
      group.appendChild(docInp);
      
      const nationaliteLab = document.createElement('label');
      nationaliteLab.textContent = 'Nationalité';
      nationaliteLab.style.marginTop = '10px';
      group.appendChild(nationaliteLab);
      
      const nationaliteInp = document.createElement('select');
      nationaliteInp.id = `pers${i}Nationalite`;
      nationaliteInp.required = true;
      nationaliteInp.className = 'guest-input';
      nationaliteInp.innerHTML = `
        <option value="">Sélectionner</option>
        <option value="Marocaine">Marocaine</option>
        <option value="Française">Française</option>
        <option value="Espagnole">Espagnole</option>
        <option value="Portugaise">Portugaise</option>
        <option value="Allemande">Allemande</option>
        <option value="Italienne">Italienne</option>
        <option value="Belge">Belge</option>
        <option value="Néerlandaise">Néerlandaise</option>
        <option value="Britannique">Britannique</option>
        <option value="Américaine">Américaine</option>
        <option value="Canadienne">Canadienne</option>
        <option value="Autre">Autre</option>
      `;
      group.appendChild(nationaliteInp);
      
      cont.appendChild(group);
    }
  }

  function buildMessage(rec){
    const nb = rec.personnes ? Object.keys(rec.personnes).length + 1 : 1;
    const nomPrincipal = rec.nom;
    const docPrincipal = rec.doc;
    const typeDocPrincipal = rec.typeDoc || 'Document';
    const nationalitePrincipal = rec.nationalite || 'Non spécifié';
    const autres = rec.personnes ? Object.values(rec.personnes).map(p => `${p.nom} (${p.typeDoc}) - ${p.doc} - ${p.nationalite}`) : [];
    
    let message = `Salam :
    
Arrivée: ${rec.date}
Appartement: ${rec.appart}
Imm: ${rec.bat}
Nombre de personnes: ${nb} personnes

Réservation au nom de:
Nom et Prénom: ${nomPrincipal}
Type de document: ${typeDocPrincipal}
Numéro: ${docPrincipal}
Nationalité: ${nationalitePrincipal}
`;

    if (autres.length > 0) {
      message += "\nAutres personnes:\n";
      autres.forEach((personne, index) => {
        message += `${index + 1}. ${personne}\n`;
      });
    }

    message += `
NB : Svp pas d'autres personnes autorisées seul Les personnes figurent dans la réservation.

Merci
------------------------------------------
السلام عليكم:

الوصول: ${rec.date}
الشقة: ${rec.appart}
رقم العمارة: ${rec.bat}
عدد الأشخاص: ${nb} أشخاص

الحجز باسم:
الإسم و اللقب: ${nomPrincipal}
نوع الوثيقة: ${typeDocPrincipal}
الرقم: ${docPrincipal}
الجنسية: ${nationalitePrincipal}
`;

    if (autres.length > 0) {
      message += "\nأشخاص آخرون:\n";
      autres.forEach((personne, index) => {
        message += `${index + 1}. ${personne}\n`;
      });
    }

    message += `
ملاحظة: الرجاء عدم السماح لأي أشخاص آخرين، فقط الأشخاص المذكورين في الحجز.

شكرًا.`;

    return message;
  }

  function generateDocumentHTML(rec) {
    const totalPersons = rec.personnes ? Object.keys(rec.personnes).length + 1 : 1;
    const now = new Date();
    const personnesList = rec.personnes ? Object.values(rec.personnes).map((p, i) => 
      `<p>${i+2}. ${p.nom} - ${p.typeDoc}: ${p.doc} - Nationalité: ${p.nationalite}</p>`
    ).join('') : '';
    
    return `
<div class="doc-title">RÈGLEMENT INTÉRIEUR DES INFORMATIONS DE L'APPARTEMENT</div>

<div class="doc-info">
  <p><strong>Date de réservation :</strong> ${now.toLocaleDateString('fr-FR')}</p>
  <p><strong>Appartement :</strong> ${rec.appart} - Immeuble : ${rec.bat}</p>
  <p><strong>Nom du réservateur :</strong> ${rec.nom}</p>
  <p><strong>Nombre de personnes :</strong> ${totalPersons}</p>
  <p><strong>Date d'arrivée :</strong> ${rec.date}</p>
</div>

<div class="doc-section">
  <div class="doc-section-title">Informations des personnes :</div>
  <p><strong>1. ${rec.nom} - ${rec.typeDoc}: ${rec.doc} - Nationalité: ${rec.nationalite}</strong></p>
  ${personnesList}
</div>

<div class="doc-section">
  <div class="doc-section-title">Règlement intérieur :</div>
  <p><strong>1. Couples marocains :</strong> Seuls les couples de la nationalité marocaine mariés sont acceptés.</p>
  <p><strong>2. Tranquillité et bruit :</strong> Silence total obligatoire après 23h00. Pas de musique forte, cris ou nuisances sonores à toute heure.</p>
  <p><strong>3. Tabagisme :</strong> Fumer est strictement interdit à l'intérieur. Autorisé uniquement en extérieur (terrasse ou jardin), avec obligation de nettoyer les mégots et cendres.</p>
  <p><strong>4. Nombre de personnes :</strong> Maximum 5 personnes autorisées dans l'appartement.</p>
  <p><strong>5. Piscine :</strong> Douche obligatoire avant la baignade. Pas de verre ni objets fragiles autour de la piscine. Surveillance permanente des enfants par un adulte. Horaires : fermeture à 20h00. Pas de courses ni plongeons.</p>
  <p><strong>6. Propreté et entretien :</strong> Maintenir les lieux propres en permanence. Vider régulièrement les poubelles. Respecter les sols et surfaces (pas de traces, pas de nourriture hors cuisine).</p>
</div>

<div class="doc-signature">
  <p>Date de signature : ${now.toLocaleDateString('fr-FR')}</p>
  <div class="doc-signature-box">
    <img src="${rec.signature || ''}" alt="Signature" style="max-width: 100%; max-height: 100%;" />
    <div class="doc-signature-text">Signature</div>
  </div>
</div>
`;
  }

  function generateAndOpenPDF(rec) {
    const pdf = new jsPDF('p', 'mm', 'a4');
    let yPos = 20;
    
    pdf.setFontSize(20);
    pdf.setTextColor(44, 62, 80);
    pdf.text('RÈGLEMENT INTÉRIEUR DES INFORMATIONS DE L\'APPARTEMENT', 105, yPos, { align: 'center' });
    yPos += 15;
    
    pdf.setDrawColor(44, 62, 80);
    pdf.setLineWidth(1);
    pdf.line(20, yPos, 190, yPos);
    yPos += 15;
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('INFORMATIONS DE LA RÉSERVATION', 20, yPos);
    yPos += 10;
    
    const totalPersons = rec.personnes ? Object.keys(rec.personnes).length + 1 : 1;
    const now = new Date();
    
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    
    pdf.text(`Date de réservation : ${now.toLocaleDateString('fr-FR')}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Appartement : ${rec.appart} - Immeuble : ${rec.bat}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Nom du réservateur : ${rec.nom}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Nombre de personnes : ${totalPersons}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Date d'arrivée : ${rec.date}`, 20, yPos);
    yPos += 15;
    
    pdf.setDrawColor(200, 200, 200);
    pdf.setLineWidth(0.5);
    pdf.line(20, yPos, 190, yPos);
    yPos += 15;
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('INFORMATIONS DES PERSONNES', 20, yPos);
    yPos += 10;
    
    pdf.setFontSize(12);
    pdf.text(`1. ${rec.nom} - ${rec.typeDoc}: ${rec.doc} - Nationalité: ${rec.nationalite}`, 20, yPos);
    yPos += 8;
    
    if (rec.personnes) {
      let counter = 2;
      Object.values(rec.personnes).forEach(p => {
        if (yPos > 250) {
          pdf.addPage();
          yPos = 20;
        }
        pdf.text(`${counter++}. ${p.nom} - ${p.typeDoc}: ${p.doc} - Nationalité: ${p.nationalite}`, 20, yPos);
        yPos += 8;
      });
    }
    
    yPos += 10;
    
    if (yPos > 200) {
      pdf.addPage();
      yPos = 20;
    }
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('RÈGLEMENT INTÉRIEUR', 20, yPos);
    yPos += 15;
    
    pdf.setFontSize(12);
    const rules = [
      '1. Couples marocains',
      'Seuls les couples de la nationalité marocaine mariés sont acceptés.',
      '',
      '2. Tranquillité et bruit',
      'Silence total obligatoire après 23h00. Pas de musique forte, cris ou nuisances',
      'sonores à toute heure, par respect pour les voisins.',
      '',
      '3. Tabagisme',
      'Fumer est strictement interdit à l\'intérieur. Autorisé uniquement en extérieur',
      '(terrasse ou jardin), avec obligation de nettoyer les mégots et cendres.',
      '',
      '4. Nombre de personnes',
      'Maximum 5 personnes autorisées dans l\'appartement.',
      '',
      '5. Piscine',
      'Douche obligatoire avant la baignade.',
      'Pas de verre ni objets fragiles autour de la piscine.',
      'Surveillance permanente des enfants par un adulte.',
      'Horaires : fermeture à 20h00.',
      'Pas de courses ni plongeons.',
      '',
      '6. Propreté et entretien',
      'Maintenir les lieux propres en permanence.',
      'Vider régulièrement les poubelles.',
      'Respecter les sols et surfaces (pas de traces, pas de nourriture hors cuisine).'
    ];

    rules.forEach(line => {
      if (yPos > 250) {
        pdf.addPage();
        yPos = 20;
      }
      pdf.text(line, 20, yPos);
      yPos += line === '' ? 5 : 7;
    });
    
    yPos += 15;
    
    if (yPos > 180) {
      pdf.addPage();
      yPos = 20;
    }
    
    pdf.text(`Date de signature : ${now.toLocaleDateString('fr-FR')}`, 20, yPos);
    yPos += 10;
    
    pdf.text('Signature :', 20, yPos);
    yPos += 10;
    
    const imgWidth = 60;
    const imgHeight = 30;
    pdf.addImage(signatureData, 'PNG', 20, yPos, imgWidth, imgHeight);
    
    const pdfBlob = pdf.output('blob');
    const pdfUrl = URL.createObjectURL(pdfBlob);
    
    window.open(pdfUrl, '_blank');
  }

  async function afficherDocument(id) {
    try {
      const recordSnapshot = await database.ref('records/' + id).once('value');
      const record = recordSnapshot.val();
      
      if (record) {
        const html = generateDocumentHTML(record);
        document.getElementById('documentPreview').innerHTML = html;
        currentDocumentData = record;
        currentDocumentData.id = id;
        document.getElementById('docActions').classList.remove('hidden');
      } else {
        document.getElementById('documentPreview').innerHTML = '<p>Document non trouvé.</p>';
        document.getElementById('docActions').classList.add('hidden');
      }
    } catch (error) {
      document.getElementById('documentPreview').innerHTML = '<p>Erreur de chargement du document.</p>';
      document.getElementById('docActions').classList.add('hidden');
    }
  }

  function downloadCurrentDocument() {
    if (!currentDocumentData) return;
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    let yPos = 20;
    
    pdf.setFontSize(20);
    pdf.setTextColor(44, 62, 80);
    pdf.text('RÈGLEMENT INTÉRIEUR DES INFORMATIONS DE L\'APPARTEMENT', 105, yPos, { align: 'center' });
    yPos += 15;
    
    pdf.setDrawColor(44, 62, 80);
    pdf.setLineWidth(1);
    pdf.line(20, yPos, 190, yPos);
    yPos += 15;
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('INFORMATIONS DE LA RÉSERVATION', 20, yPos);
    yPos += 10;
    
    const totalPersons = currentDocumentData.personnes ? Object.keys(currentDocumentData.personnes).length + 1 : 1;
    const now = new Date();
    
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    
    pdf.text(`Date de réservation : ${now.toLocaleDateString('fr-FR')}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Appartement : ${currentDocumentData.appart} - Immeuble : ${currentDocumentData.bat}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Nom du réservateur : ${currentDocumentData.nom}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Nombre de personnes : ${totalPersons}`, 20, yPos);
    yPos += 8;
    
    pdf.text(`Date d'arrivée : ${currentDocumentData.date}`, 20, yPos);
    yPos += 15;
    
    pdf.setDrawColor(200, 200, 200);
    pdf.setLineWidth(0.5);
    pdf.line(20, yPos, 190, yPos);
    yPos += 15;
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('INFORMATIONS DES PERSONNES', 20, yPos);
    yPos += 10;
    
    pdf.setFontSize(12);
    pdf.text(`1. ${currentDocumentData.nom} - ${currentDocumentData.typeDoc}: ${currentDocumentData.doc} - Nationalité: ${currentDocumentData.nationalite}`, 20, yPos);
    yPos += 8;
    
    if (currentDocumentData.personnes) {
      let counter = 2;
      Object.values(currentDocumentData.personnes).forEach(p => {
        if (yPos > 250) {
          pdf.addPage();
          yPos = 20;
        }
        pdf.text(`${counter++}. ${p.nom} - ${p.typeDoc}: ${p.doc} - Nationalité: ${p.nationalite}`, 20, yPos);
        yPos += 8;
      });
    }
    
    yPos += 10;
    
    if (yPos > 200) {
      pdf.addPage();
      yPos = 20;
    }
    
    pdf.setFontSize(14);
    pdf.setTextColor(44, 62, 80);
    pdf.text('RÈGLEMENT INTÉRIEUR', 20, yPos);
    yPos += 15;
    
    pdf.setFontSize(12);
    const rules = [
      '1. Couples marocains',
      'Seuls les couples de la nationalité marocaine mariés sont acceptés.',
      '',
      '2. Tranquillité et bruit',
      'Silence total obligatoire après 23h00. Pas de musique forte, cris ou nuisances',
      'sonores à toute heure, par respect pour les voisins.',
      '',
      '3. Tabagisme',
      'Fumer est strictement interdit à l\'intérieur. Autorisé uniquement en extérieur',
      '(terrasse ou jardin), avec obligation de nettoyer les mégots et cendres.',
      '',
      '4. Nombre de personnes',
      'Maximum 5 personnes autorisées dans l\'appartement.',
      '',
      '5. Piscine',
      'Douche obligatoire avant la baignade.',
      'Pas de verre ni objets fragiles autour de la piscine.',
      'Surveillance permanente des enfants par un adulte.',
      'Horaires : fermeture à 20h00.',
      'Pas de courses ni plongeons.',
      '',
      '6. Propreté et entretien',
      'Maintenir les lieux propres en permanence.',
      'Vider régulièrement les poubelles.',
      'Respecter les sols et surfaces (pas de traces, pas de nourriture hors cuisine).'
    ];

    rules.forEach(line => {
      if (yPos > 250) {
        pdf.addPage();
        yPos = 20;
      }
      pdf.text(line, 20, yPos);
      yPos += line === '' ? 5 : 7;
    });
    
    yPos += 15;
    
    if (yPos > 180) {
      pdf.addPage();
      yPos = 20;
    }
    
    pdf.text(`Date de signature : ${now.toLocaleDateString('fr-FR')}`, 20, yPos);
    yPos += 10;
    
    pdf.text('Signature :', 20, yPos);
    yPos += 10;
    
    const imgWidth = 60;
    const imgHeight = 30;
    pdf.addImage(currentDocumentData.signature, 'PNG', 20, yPos, imgWidth, imgHeight);
    
    pdf.save(`document_signe_${currentDocumentData.nom.replace(/\s+/g, '_')}.pdf`);
  }

  function viewCurrentDocument() {
    if (!currentDocumentData) return;
    generateAndOpenPDF(currentDocumentData);
  }

  async function envoyerWhatsApp(id){
    try {
      const snapshot = await database.ref('records/' + id).once('value');
      const r = snapshot.val();
      
      if(!r){ 
        showBanner('err',"Enregistrement introuvable."); 
        return; 
      }
      
      const msg = buildMessage(r);
      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
      
      await database.ref('records/' + id).update({ sent: true });
      
      if(currentUser.role === 'admin') refreshAdmin();
      else refreshUser();
    } catch (error) {
      showBanner('err',"Erreur de lecture de l'enregistrement.");
    }
  }

  document.getElementById('btnLogin').disabled = false;
  
  const params = new URLSearchParams(location.search);
  if(params.has("invite")) {
    enterInviteMode(params.get("invite"));
  }
</script>
</body>
</html>
```