<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Application Invités</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#f2f2f2; padding:20px }
.card { background:white; padding:15px; border-radius:10px; margin-bottom:15px }
.hidden { display:none }
input, button { width:100%; padding:10px; margin-top:8px }
button { background:#007bff; color:white; border:none; border-radius:6px }
table { width:100%; border-collapse:collapse }
th, td { border:1px solid #ccc; padding:8px; text-align:center }
th { background:#007bff; color:white }
</style>
</head>

<body>

<h2>Gestion des invités</h2>

<!-- ================= CONNEXION ================= -->
<div id="loginCard" class="card">
  <input id="loginId" placeholder="Appartement + Bâtiment (ex: 12A)">
  <input id="loginPass" type="password" placeholder="Mot de passe">
  <button onclick="login()">Connexion</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="card hidden">
  <h3>Admin</h3>
  <button onclick="logout()">Déconnexion</button>
  <table>
    <thead><tr><th>ID</th><th>Appartement</th><th>Bâtiment</th></tr></thead>
    <tbody id="adminTable"></tbody>
  </table>
</div>

<!-- ================= UTILISATEUR ================= -->
<div id="userPanel" class="card hidden">
  <h3>Mon appartement</h3>
  <button onclick="logout()">Déconnexion</button>
  <button onclick="createInvite()">Générer lien invité</button>
  <p id="inviteLink"></p>

  <table>
    <thead><tr><th>Nom</th><th>Document</th><th>Date</th></tr></thead>
    <tbody id="userTable"></tbody>
  </table>
</div>

<!-- ================= INVITÉ ================= -->
<div id="invitePanel" class="card hidden">
  <h3>Formulaire invité</h3>
  <input id="invApp" disabled>
  <input id="invBat" disabled>
  <input id="invNom" placeholder="Nom">
  <input id="invDoc" placeholder="Document">
  <button onclick="saveInvite()">Valider</button>
</div>

<script>
// ================= FIREBASE CONFIG =================
firebase.initializeApp({
  apiKey: "AIzaSyC6uSDTNCuw5sHNVaNgq0EzJqJZ9jgic7U",
  authDomain: "dddiii-2b58b.firebaseapp.com",
  databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dddiii-2b58b"
});

const db = firebase.database();
let currentUser = null;

// ================= LOGIN =================
async function login() {
  const id = loginId.value.trim();
  const pass = loginPass.value.trim();

  const snap = await db.ref("users/" + id).once("value");
  const user = snap.val();

  if (!user || user.pass !== pass) {
    alert("Identifiants incorrects");
    return;
  }

  currentUser = user;
  loginCard.classList.add("hidden");

  if (id === "admin") {
    adminPanel.classList.remove("hidden");
    loadUsers();
  } else {
    userPanel.classList.remove("hidden");
    loadRecords();
  }
}

// ================= ADMIN =================
async function loadUsers() {
  const snap = await db.ref("users").once("value");
  const users = snap.val();
  adminTable.innerHTML = "";
  Object.values(users).forEach(u => {
    adminTable.innerHTML += `<tr><td>${u.appart}${u.bat}</td><td>${u.appart}</td><td>${u.bat}</td></tr>`;
  });
}

// ================= UTILISATEUR =================
async function loadRecords() {
  const snap = await db.ref("records").once("value");
  const recs = snap.val() || {};
  userTable.innerHTML = "";
  Object.values(recs).filter(r =>
    r.appart === currentUser.appart && r.bat === currentUser.bat
  ).forEach(r => {
    userTable.innerHTML += `<tr><td>${r.nom}</td><td>${r.doc}</td><td>${r.date}</td></tr>`;
  });
}

// ================= INVITE =================
async function createInvite() {
  const ref = db.ref("invites").push({
    appart: currentUser.appart,
    bat: currentUser.bat
  });
  inviteLink.innerHTML = location.href + "?invite=" + ref.key;
}

async function saveInvite() {
  await db.ref("records").push({
    appart: invApp.value,
    bat: invBat.value,
    nom: invNom.value,
    doc: invDoc.value,
    date: new Date().toLocaleDateString()
  });
  alert("Enregistré");
}

// ================= LOGOUT =================
function logout() {
  location.reload();
}

// ================= INVITE MODE =================
const params = new URLSearchParams(location.search);
if (params.has("invite")) {
  loginCard.classList.add("hidden");
  invitePanel.classList.remove("hidden");

  db.ref("invites/" + params.get("invite")).once("value").then(s => {
    const d = s.val();
    invApp.value = d.appart;
    invBat.value = d.bat;
  });
}
</script>

</body>
</html>
