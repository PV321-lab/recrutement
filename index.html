<?php
session_start();

$host = "localhost";
$dbname = "gestion_invites";
$username = "root";
$password = "";

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch(PDOException $e) {
    die("Erreur de connexion : " . $e->getMessage());
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['login'])) {
    $user = $_POST['user'];
    $pass = $_POST['password'];
    
    $stmt = $pdo->prepare("SELECT * FROM appartements WHERE numero = ? AND password = ?");
    $stmt->execute([$user, $pass]);
    $appartement = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($appartement) {
        $_SESSION['appartement_id'] = $appartement['id'];
        $_SESSION['appartement_numero'] = $appartement['numero'];
        $_SESSION['batiment_id'] = $appartement['batiment_id'];
        
        $stmt = $pdo->prepare("SELECT * FROM enregistrements WHERE appartement_id = ? ORDER BY date_creation DESC");
        $stmt->execute([$appartement['id']]);
        $enregistrements = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo '<!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Enregistrement des invités</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .container { max-width: 1200px; margin: 0 auto; }
                .header { background: #f0f0f0; padding: 20px; margin-bottom: 20px; }
                .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                .btn-generate { background: #4CAF50; color: white; border: none; }
                .btn-logout { background: #f44336; color: white; border: none; }
                .link-container { background: #e8f5e9; padding: 15px; margin: 20px 0; display: none; }
                .link-container input { width: 70%; padding: 10px; margin-right: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                th { background-color: #4CAF50; color: white; }
                tr:nth-child(even) { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h2>Enregistrement des invités - Appartement '.$appartement['numero'].'</h2>
                    <p>Bâtiment: '.$appartement['batiment_id'].'</p>
                    <button class="btn btn-generate" onclick="generateLink()">Générer lien</button>
                    <button class="btn btn-logout" onclick="logout()">Déconnexion</button>
                </div>
                
                <div class="link-container" id="linkContainer">
                    <input type="text" id="generatedLink" readonly>
                    <button onclick="copyLink()">Copier</button>
                </div>';
        
        if (count($enregistrements) > 0) {
            echo '<table>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Date</th>
                    </tr>';
            foreach ($enregistrements as $row) {
                echo '<tr>
                        <td>'.$row['nom_complet'].'</td>
                        <td>'.$row['email'].'</td>
                        <td>'.$row['telephone'].'</td>
                        <td>'.$row['date_creation'].'</td>
                      </tr>';
            }
            echo '</table>';
        } else {
            echo '<p>Aucun enregistrement trouvé.</p>';
        }
        
        echo '<script>
                function generateLink() {
                    var token = Math.random().toString(36).substring(2);
                    var link = window.location.origin + "/enregistrement.php?token=" + token + "&apt=" + '.$appartement['id'].';
                    document.getElementById("generatedLink").value = link;
                    document.getElementById("linkContainer").style.display = "block";
                }
                function copyLink() {
                    var copyText = document.getElementById("generatedLink");
                    copyText.select();
                    document.execCommand("copy");
                    alert("Lien copié!");
                }
                function logout() {
                    window.location.href = "?logout=1";
                }
              </script>
            </div>
        </body>
        </html>';
    } else {
        echo '<div style="color:red; text-align:center;">Identifiants incorrects</div>';
        showLoginForm();
    }
    exit();
}

if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: ".$_SERVER['PHP_SELF']);
    exit();
}

showLoginForm();

function showLoginForm() {
    echo '<!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Connexion</title>
        <style>
            body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
            .login-box { width: 300px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
            h2 { text-align: center; }
            .input-group { margin-bottom: 15px; }
            label { display: block; margin-bottom: 5px; }
            input { width: 100%; padding: 8px; box-sizing: border-box; }
            button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
            .error { color: red; text-align: center; margin-top: 10px; }
        </style>
    </head>
    <body>
        <div class="login-box">
            <h2>Enregistrement des invités</h2>
            <h3>Connexion</h3>
            <p>Veuillez entrer vos identifiants</p>
            <form method="POST">
                <input type="hidden" name="login" value="1">
                <div class="input-group">
                    <label>Utilisateur</label>
                    <input type="text" name="user" required>
                </div>
                <div class="input-group">
                    <label>Mot de passe</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit">Connexion</button>
            </form>
        </div>
    </body>
    </html>';
}
?>