<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* mêmes styles que ton code */
  </style>
</head>
<body>
<h2>Enregistrement des invités</h2>
<div id="banner" class="banner info hidden"></div>

<!-- Connexion -->
<div id="loginCard" class="card">
  <label>Utilisateur</label>
  <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required />
  <label>Mot de passe</label>
  <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required />
  <button id="btnLogin" onclick="login()">Connexion</button>
  <p id="loginMsg" class="banner err hidden"></p>
</div>

<div id="adminPanel" class="hidden"></div>
<div id="userPanel" class="hidden"></div>
<div id="invitePanel" class="hidden"></div>

<script>
/* ======================= CONFIGURATION FIREBASE ======================== */
const firebaseConfig = {
  databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* ======================= QR CODE MESSAGE ======================== */
function buildQrMessage(rec){
  const nb = rec.personnes ? Object.keys(rec.personnes).length + 1 : 1;
  let msg = `Appartement: ${rec.appart}
Bâtiment: ${rec.bat}
Date d'arrivée: ${rec.date}
Nombre de personnes: ${nb}

Nom & Prénom: ${rec.nom}
Passeport: ${rec.doc}
`;
  if(rec.personnes){
    msg += "\nAutres personnes:\n";
    Object.values(rec.personnes).forEach((p,i)=>{
      msg += `${i+1}. ${p.nom} - ${p.doc}\n`;
    });
  }
  return msg;
}

/* ======================= SUPPRESSION ======================== */
async function supprimerRecord(id){
  if(confirm("Voulez-vous vraiment supprimer cet enregistrement ?")){
    try{
      await database.ref('records/' + id).remove();
      showBanner('ok',"Enregistrement supprimé.");
      if(currentUser?.role === 'admin') refreshAdmin();
      else refreshUser();
    }catch(e){
      showBanner('err',"Erreur lors de la suppression.");
    }
  }
}

/* ======================= ADAPTATION TABLE ADMIN ======================== */
async function refreshAdmin(){
  const tbody = document.querySelector('#tableAdmin tbody');
  tbody.innerHTML = '';
  try {
    const recordsSnapshot = await database.ref('records').once('value');
    const records = recordsSnapshot.val() || {};
    Object.entries(records).slice(-200).forEach(([id, r])=>{
      const personnesList = r.personnes ? Object.values(r.personnes).map(p=>`${p.nom} - ${p.doc}`).join(', ') : '';
      const sendBtn = `<button onclick="envoyerWhatsApp('${id}')">Envoyer</button>`;
      const delBtn = `<button onclick="supprimerRecord('${id}')">Supprimer</button>`;
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${id}</td>
          <td>${r.appart}</td>
          <td>${r.bat}</td>
          <td>${r.nom}</td>
          <td>${r.doc}</td>
          <td>${r.personnes ? Object.keys(r.personnes).length + 1 : 1}</td>
          <td>${personnesList}</td>
          <td>${r.date}</td>
          <td>${sendBtn} ${delBtn}</td>
          <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
        </tr>`);
    });
  } catch {
    showBanner('err',"Erreur chargement enregistrements.");
  }
}

/* ======================= ADAPTATION TABLE UTILISATEUR ======================== */
async function refreshUser(){
  const tbody = document.querySelector('#tableUser tbody');
  tbody.innerHTML = '';
  try {
    const recordsSnapshot = await database.ref('records').once('value');
    const records = recordsSnapshot.val() || {};
    Object.entries(records)
      .filter(([id,r]) => r.appart===currentUser.appart && r.bat===currentUser.bat)
      .slice(-200).forEach(([id,r])=>{
        const personnesList = r.personnes ? Object.values(r.personnes).map(p=>`${p.nom} - ${p.doc}`).join(', ') : '';
        const sendBtn = `<button onclick="envoyerWhatsApp('${id}')">Envoyer</button>`;
        const delBtn = `<button onclick="supprimerRecord('${id}')">Supprimer</button>`;
        tbody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${id}</td>
            <td>${r.nom}</td>
            <td>${r.doc}</td>
            <td>${r.personnes ? Object.keys(r.personnes).length + 1 : 1}</td>
            <td>${personnesList}</td>
            <td>${r.date}</td>
            <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
            <td>${sendBtn} ${delBtn}</td>
          </tr>`);
      });
  } catch {
    showBanner('err',"Erreur lecture enregistrements.");
  }
}

/* ======================= ENREGISTRER + QR ======================== */
async function enregistrer(){
  const nom = document.getElementById('nomPrincipal').value.trim();
  const doc = document.getElementById('docPrincipal').value.trim();
  const date = document.getElementById('dateArrivee').value;
  const nb = parseInt(document.getElementById('nbPers').value || '1');
  if(!nom || !doc || !date) return showBanner('warn',"Champs obligatoires.");

  const personnes = {};
  for(let i=2;i<=nb;i++){
    const nomVal=document.getElementById(`pers${i}Nom`).value.trim();
    const docVal=document.getElementById(`pers${i}Doc`).value.trim();
    personnes[`pers${i-1}`]={nom:nomVal,doc:docVal};
  }

  const appart=document.getElementById('invAppart').value;
  const bat=document.getElementById('invBat').value;
  const rec={appart,bat,nom,doc,personnes,date,sent:false};

  try{
    const newRef=database.ref('records').push();
    await newRef.set(rec);
    rec.id=newRef.key;

    const qrMsg=buildQrMessage(rec);
    qrCode.update({data:qrMsg});
    document.getElementById('qrcode').innerHTML='';
    qrCode.append(document.getElementById('qrcode'));
    showBanner('ok',"Enregistrement effectué !");
  }catch{
    showBanner('err',"Erreur enregistrement.");
  }
}
</script>
</body>
</html>