<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Premium Village - Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Scripts de base -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{ --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4; }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, select, button { font-size:16px; width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing: border-box; }
    button { background:var(--c1); color:#fff; border:none; cursor:pointer; font-weight: bold; margin-top: 15px; }
    button:hover { opacity: 0.9; }
    .hidden { display:none !important; }
    .banner { padding:10px; border-radius:8px; margin-top:10px; font-weight:bold; text-align:center; }
    .banner.err { background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .banner.ok { background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .premium-header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .col { flex:1; min-width:200px; }
    .signature-canvas { width: 100%; height: 150px; border: 1px solid #ccc; background: #fff; margin-top: 10px; }
  </style>
</head>
<body>

<div class="premium-header">
  <h1>Premium Village</h1>
  <p>Gestion des enregistrements</p>
</div>

<div id="loginCard" class="card" style="max-width: 400px; margin: 0 auto;">
  <h3 style="text-align:center;">Connexion</h3>
  <label>Utilisateur (Appartement + Immeuble)</label>
  <input type="text" id="loginUser" placeholder="Ex: 6A6" />
  <label>Mot de passe</label>
  <input type="password" id="loginPass" placeholder="Votre mot de passe" />
  <button id="btnLogin" onclick="handleLogin()">Se connecter</button>
  <p id="loginMsg" class="banner err hidden"></p>
</div>

<!-- Panneau Utilisateur -->
<div id="userPanel" class="hidden">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Mon Espace</h3>
      <button onclick="location.reload()" style="width:auto; margin:0; background:#6c757d;">Déconnexion</button>
    </div>
    <div class="row">
      <div class="col">
        <label>Email de notification (Sécurité)</label>
        <input type="email" id="guardEmail" placeholder="securite@exemple.com" />
        <button onclick="saveSettings()" style="background:var(--ok);">Enregistrer Email</button>
      </div>
      <div class="col">
        <label>Test</label>
        <button onclick="testEmail()" style="background:var(--info);">Tester l'envoi Email</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Mes Enregistrements</h3>
      <button onclick="generateInviteLink()" style="width:auto; margin:0; background:var(--ok);">Générer Lien Invité</button>
    </div>
    <table id="tableUser">
      <thead>
        <tr><th>N°</th><th>Nom</th><th>Date</th><th>Statut</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Panneau Invité -->
<div id="invitePanel" class="hidden">
  <div class="card">
    <h3 id="inviteTitle">Enregistrement Invité</h3>
    <label>Nom et Prénom</label>
    <input type="text" id="guestNom" required />
    <div class="row">
      <div class="col">
        <label>Type Document</label>
        <select id="guestTypeDoc"><option>CIN</option><option>Passeport</option></select>
      </div>
      <div class="col">
        <label>N° Document</label>
        <input type="text" id="guestDoc" required />
      </div>
    </div>
    <label>Date d'arrivée</label>
    <input type="date" id="guestDate" required />
    
    <div id="others">
      <label>Autres personnes</label>
      <div id="othersList"></div>
      <button onclick="addOther()" style="background:#6c757d; width:auto;">+ Ajouter</button>
    </div>

    <label>Signature</label>
    <canvas id="sigCanvas" class="signature-canvas"></canvas>
    <button onclick="clearSig()" style="background:#6c757d; width:auto;">Effacer</button>

    <button onclick="submitGuest()" style="background:var(--ok); padding:15px;">ENREGISTRER ET TÉLÉCHARGER PDF</button>
  </div>
</div>

<script>
  // CONFIGURATION FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSy...", // À REMPLACER
    authDomain: "premium-village.firebaseapp.com",
    databaseURL: "https://premium-village-default-rtdb.firebaseio.com",
    projectId: "premium-village",
    storageBucket: "premium-village.appspot.com",
    messagingSenderId: "...",
    appId: "..."
  };

  // INITIALISATION
  try {
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();
    console.log("Firebase initialisé");
  } catch(e) {
    alert("Erreur d'initialisation Firebase : " + e.message);
  }

  // EMAILJS
  const emailConfig = {
    s: 'service_qnnmvxe',
    p: 'IWJc8rbQr6EMWWQbs',
    t: 'template_default'
  };
  emailjs.init(emailConfig.p);

  let currentUser = null;
  let inviteData = null;

  // FONCTION DE CONNEXION
  async function handleLogin() {
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const msg = document.getElementById('loginMsg');
    const btn = document.getElementById('btnLogin');

    console.log("Tentative:", user, pass);
    
    if(!user || !pass) {
      msg.textContent = "Champs vides";
      msg.classList.remove('hidden');
      return;
    }

    btn.disabled = true;
    btn.textContent = "Vérification...";
    msg.classList.add('hidden');

    try {
      const snapshot = await database.ref('users').once('value');
      const users = snapshot.val();
      let found = false;

      if(users) {
        for(let id in users) {
          const u = users[id];
          const combo = String(u.appart) + String(u.bat || "");
          if((user === combo || user === String(u.appart)) && String(u.pass) === pass) {
            currentUser = u;
            currentUser.id = id;
            found = true;
            break;
          }
        }
      }

      if(found) {
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('userPanel').classList.remove('hidden');
        loadUserRecords();
        document.getElementById('guardEmail').value = currentUser.guardEmail || "";
      } else {
        msg.textContent = "Identifiants incorrects";
        msg.classList.remove('hidden');
      }
    } catch(e) {
      console.error(e);
      alert("Erreur base de données : " + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Se connecter";
    }
  }

  // CHARGEMENT DONNÉES
  function loadUserRecords() {
    database.ref('records').orderByChild('userId').equalTo(currentUser.id).on('value', snap => {
      const records = snap.val();
      const tbody = document.querySelector('#tableUser tbody');
      tbody.innerHTML = '';
      let i = 1;
      for(let id in records) {
        const r = records[id];
        tbody.innerHTML += `<tr>
          <td>${i++}</td><td>${r.nom}</td><td>${r.date}</td>
          <td>${r.sent ? '✅' : '⏳'}</td>
          <td><button onclick="sendWA('${id}')" style="background:#25D366; margin:0; padding:5px;">WA</button></td>
        </tr>`;
      }
    });
  }

  // WHATSAPP MESSAGE
  function getWAMessage(r) {
    const autres = r.personnes ? Object.values(r.personnes).map((p, i) => `${i+1}. ${p.nom} - ${p.doc}`).join('\n') : 'Aucun';
    return `Salam :
Arrivée: ${r.date}
Appartement: ${r.appart}
Imm: ${r.bat}
Nombre de personnes: ${r.personnes ? Object.keys(r.personnes).length + 1 : 1}

Réservation au nom de:
Nom: ${r.nom}
Passeport: ${r.doc}

Autres:
${autres}

NB: Seul les personnes figurant dans la réservation sont autorisées. Merci.
--------------------
السلام عليكم:
الوصول: ${r.date}
الشقة: ${r.appart}
العمارة: ${r.bat}
عدد الأشخاص: ${r.personnes ? Object.keys(r.personnes).length + 1 : 1}
الحجز باسم: ${r.nom}
جواز السفر: ${r.doc}
أشخاص آخرون:
${autres}
ملاحظة: فقط الأشخاص المذكورين في الحجز. شكرا.`;
  }

  async function sendWA(id) {
    const snap = await database.ref('records/' + id).once('value');
    const r = snap.val();
    window.open(`https://wa.me/?text=${encodeURIComponent(getWAMessage(r))}`, '_blank');
  }

  // GESTION PARAMÈTRES
  async function saveSettings() {
    const email = document.getElementById('guardEmail').value;
    await database.ref('users/' + currentUser.id).update({ guardEmail: email });
    alert("Email enregistré");
  }

  async function testEmail() {
    const email = document.getElementById('guardEmail').value;
    if(!email) return alert("Entrez un email");
    try {
      await emailjs.send(emailConfig.s, emailConfig.t, { to_email: email, message: "Test Premium Village" });
      alert("Email envoyé !");
    } catch(e) { alert("Erreur EmailJS"); }
  }

  // GESTION INVITÉ
  function generateInviteLink() {
    const url = window.location.origin + window.location.pathname + "?invite=" + currentUser.id;
    prompt("Lien à copier :", url);
  }

  // SIGNATURE
  const canvas = document.getElementById('sigCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  canvas.addEventListener('mousedown', () => drawing = true);
  canvas.addEventListener('mouseup', () => drawing = false);
  canvas.addEventListener('mousemove', (e) => {
    if(!drawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
  });
  function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); }

  function addOther() {
    const div = document.createElement('div');
    div.innerHTML = `<input type="text" placeholder="Nom" class="o-nom" style="width:45%"> <input type="text" placeholder="Doc" class="o-doc" style="width:45%">`;
    document.getElementById('othersList').appendChild(div);
  }

  async function submitGuest() {
    const nom = document.getElementById('guestNom').value;
    const doc = document.getElementById('guestDoc').value;
    const date = document.getElementById('guestDate').value;
    if(!nom || !doc || !date) return alert("Remplissez tout");

    const personnes = {};
    document.querySelectorAll('#othersList div').forEach((d, i) => {
      personnes['p'+i] = { nom: d.querySelector('.o-nom').value, doc: d.querySelector('.o-doc').value };
    });

    const record = {
      userId: inviteData.userId,
      appart: inviteData.appart,
      bat: inviteData.bat,
      nom, doc, date, personnes,
      signature: canvas.toDataURL(),
      timestamp: Date.now()
    };

    const newRef = database.ref('records').push();
    await newRef.set(record);

    // Email Auto
    const uSnap = await database.ref('users/' + inviteData.userId).once('value');
    const u = uSnap.val();
    if(u && u.guardEmail) {
      emailjs.send(emailConfig.s, emailConfig.t, {
        to_email: u.guardEmail,
        message: `Nouvel invité: ${nom} (${doc}) pour l'appartement ${u.appart}${u.bat}`
      });
    }

    alert("Enregistré !");
    generatePDF(record);
  }

  function generatePDF(r) {
    const doc = new jspdf.jsPDF();
    doc.text("PREMIUM VILLAGE - ENREGISTREMENT", 10, 10);
    doc.text(`Nom: ${r.nom}`, 10, 20);
    doc.text(`Document: ${r.doc}`, 10, 30);
    doc.text(`Appartement: ${r.appart}${r.bat}`, 10, 40);
    doc.text(`Date: ${r.date}`, 10, 50);
    doc.addImage(r.signature, 'PNG', 10, 60, 50, 25);
    doc.save(`Enregistrement_${r.nom}.pdf`);
  }

  // MODE INVITÉ
  const params = new URLSearchParams(location.search);
  if(params.has('invite')) {
    const uid = params.get('invite');
    database.ref('users/' + uid).once('value', snap => {
      const u = snap.val();
      if(u) {
        inviteData = { userId: uid, appart: u.appart, bat: u.bat };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('invitePanel').classList.remove('hidden');
        document.getElementById('inviteTitle').textContent = `Enregistrement - Appartement ${u.appart}${u.bat}`;
      }
    });
  }
</script>
</body>
</html>
