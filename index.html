<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <!-- Intégration de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root{ --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4; }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, button { font-size:16px; }
    input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:6px; padding:6px 10px; border:none; border-radius:6px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:6px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>

<h2>Enregistrement des invités</h2>
<div id="banner" class="banner info hidden"></div>

<!-- Connexion -->
<div id="loginCard" class="card">
  <div class="toolbar">
    <div><strong>Connexion</strong></div>
    <div class="note">Veuillez entrer vos identifiants</div>
  </div>
  <label>Utilisateur</label>
  <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required />
  <label>Mot de passe</label>
  <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required />
  <button id="btnLogin" onclick="login()">Connexion</button>
  <p id="loginMsg" class="banner err hidden"></p>
</div>

<!-- Interface Admin -->
<div id="adminPanel" class="hidden">
  <div class="toolbar card">
    <div><strong>Panneau administrateur</strong></div>
    <div><button onclick="logout()">Déconnexion</button></div>
  </div>
  <table id="tableAdmin">
    <thead>
      <tr><th>ID</th><th>Appart</th><th>Bat</th><th>Nom</th><th>Doc</th><th>Nb Pers</th><th>Liste</th><th>Date</th><th>Action</th><th>Statut</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Interface Utilisateur -->
<div id="userPanel" class="hidden">
  <div class="toolbar card">
    <div><strong>Mon espace</strong></div>
    <div><button onclick="logout()">Déconnexion</button></div>
  </div>
  <table id="tableUser">
    <thead>
      <tr><th>ID</th><th>Nom</th><th>Doc</th><th>Nb Pers</th><th>Liste</th><th>Date</th><th>Statut</th><th>Envoyer</th><th>Supprimer</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Interface Invité -->
<div id="invitePanel" class="hidden">
  <div class="guest-form-container">
    <div class="toolbar" style="margin-bottom: 20px;">
      <h3 style="margin: 0; flex-grow: 1;">Enregistrement Invité</h3>
    </div>
    <form id="guestForm">
      <label>Appartement</label>
      <input type="text" id="invAppart" readonly />
      <label>Immeuble</label>
      <input type="text" id="invBat" readonly />
      <label>Nom principal</label>
      <input type="text" id="nomPrincipal" required />
      <label>Document principal</label>
      <input type="text" id="docPrincipal" required />
      <label>Date d'arrivée</label>
      <input type="date" id="dateArrivee" required />
      <label>Nombre de personnes</label>
      <input type="number" id="nbPers" min="1" value="1" onchange="genererChamps()" />
      <div id="personnes"></div>
      <div style="margin:10px 0;">
        <input type="checkbox" id="consentCheckbox" /> J'accepte le traitement des données.
      </div>
      <button type="submit">Enregistrer</button>
    </form>
    <div id="successMessage" class="banner ok hidden">Enregistrement effectué avec succès.</div>
    <div id="qrcodeContainer" class="hidden">
      <div id="qrcode"></div>
      <button id="downloadBtn">Télécharger le QR</button>
    </div>
  </div>
</div>

<script>
/* =======================
   CONFIGURATION FIREBASE
======================== */
const firebaseConfig = {
  databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentUser = null;
let qrCode = null;

/* =======================
   UI HELPERS
======================== */
function showBanner(type, text){
  const b = document.getElementById('banner');
  b.className = 'banner ' + type;
  b.textContent = text;
  b.classList.remove('hidden');
}
function hideBanner(){ document.getElementById('banner').classList.add('hidden'); }

/* =======================
   LOGIN
======================== */
async function login(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u === 'admin' && p === 'admin'){
    currentUser = { role:'admin' };
    document.getElementById('loginCard').classList.add('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
    refreshAdmin();
    return;
  }
  try {
    const snapshot = await database.ref('users/' + u).once('value');
    const user = snapshot.val();
    if(user && user.pass === p){
      currentUser = { role:'user', id:u, appart:user.appart, bat:user.bat };
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('userPanel').classList.remove('hidden');
      refreshUser();
    } else {
      showBanner('err',"Identifiants incorrects.");
    }
  } catch(e){ showBanner('err',"Erreur accès base."); }
}

function logout(){
  currentUser = null;
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('userPanel').classList.add('hidden');
  document.getElementById('invitePanel').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
}

/* =======================
   ADMIN
======================== */
async function refreshAdmin(){
  const tbody = document.querySelector('#tableAdmin tbody');
  tbody.innerHTML = '';
  const snapshot = await database.ref('records').once('value');
  const records = snapshot.val() || {};
  Object.entries(records).forEach(([id,r])=>{
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${id}</td><td>${r.appart}</td><td>${r.bat}</td><td>${r.nom}</td>
      <td>${r.doc}</td><td>${r.personnes?Object.keys(r.personnes).length+1:1}</td>
      <td>${r.personnes?Object.values(r.personnes).map(p=>p.nom).join(', '):''}</td>
      <td>${r.date}</td>
      <td><button onclick="envoyerWhatsApp('${id}')">Envoyer</button></td>
      <td>${r.sent?"Envoyé":"Non envoyé"}</td></tr>`);
  });
}

/* =======================
   USER
======================== */
async function refreshUser(){
  const tbody = document.querySelector('#tableUser tbody');
  tbody.innerHTML = '';
  const snapshot = await database.ref('records').once('value');
  const records = snapshot.val() || {};
  Object.entries(records)
    .filter(([id,r])=>r.appart===currentUser.appart && r.bat===currentUser.bat)
    .forEach(([id,r])=>{
      const sendBtn = `<button onclick="envoyerWhatsApp('${id}')">Envoyer</button>`;
      const delBtn = `<button style="background:red" onclick="supprimerRecord('${id}')">Supprimer</button>`;
      tbody.insertAdjacentHTML('beforeend',
        `<tr id="row-${id}">
          <td>${id}</td><td>${r.nom}</td><td>${r.doc}</td>
          <td>${r.personnes?Object.keys(r.personnes).length+1:1}</td>
          <td>${r.personnes?Object.values(r.personnes).map(p=>p.nom).join(', '):''}</td>
          <td>${r.date}</td>
          <td>${r.sent?"Envoyé":"Non envoyé"}</td>
          <td>${sendBtn}</td>
          <td>${delBtn}</td>
        </tr>`);
    });
}

async function supprimerRecord(id){
  if(confirm("Supprimer cet enregistrement ?")){
    await database.ref('records/'+id).remove();
    const row=document.getElementById('row-'+id);
    if(row) row.remove();
    showBanner('ok',"Enregistrement supprimé.");
  }
}

/* =======================
   GUEST / QR CODE
======================== */
async function enterInviteMode(userId){
  const snapshot=await database.ref('users/'+userId).once('value');
  const user=snapshot.val();
  if(!user){ showBanner('err',"Utilisateur introuvable."); return;}
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('invitePanel').classList.remove('hidden');
  document.getElementById('invAppart').value=user.appart;
  document.getElementById('invBat').value=user.bat;
  qrCode=new QRCodeStyling({width:250,height:250});
  document.getElementById('guestForm').addEventListener('submit',async e=>{
    e.preventDefault(); await enregistrer();
  });
  document.getElementById('downloadBtn').addEventListener('click',()=>qrCode.download({name:"QR",extension:"png"}));
}

function genererChamps(){
  const nb=parseInt(document.getElementById('nbPers').value||'1',10);
  const cont=document.getElementById('personnes'); cont.innerHTML='';
  for(let i=2;i<=nb;i++){
    cont.insertAdjacentHTML('beforeend',
      `<div><label>Nom & prénom ${i}</label><input id="pers${i}Nom"/>
       <label>Doc ${i}</label><input id="pers${i}Doc"/></div>`);
  }
}

async function enregistrer(){
  if(!document.getElementById('consentCheckbox').checked){ showBanner('warn',"Cochez la case."); return;}
  const nom=document.getElementById('nomPrincipal').value.trim();
  const doc=document.getElementById('docPrincipal').value.trim();
  const date=document.getElementById('dateArrivee').value;
  if(!nom||!doc||!date){ showBanner('warn',"Tous les champs requis."); return;}
  const appart=document.getElementById('invAppart').value;
  const bat=document.getElementById('invBat').value;
  const rec={appart,bat,nom,doc,date,sent:false};
  const newRef=database.ref('records').push();
  await newRef.set(rec);
  const id=newRef.key;
  rec.id=id;
  document.getElementById('successMessage').classList.remove('hidden');
  document.getElementById('qrcodeContainer').classList.remove('hidden');
  // QR CODE AVEC ID UNIQUE
  qrCode.update({data:id});
  document.getElementById('qrcode').innerHTML='';
  qrCode.append(document.getElementById('qrcode'));
  document.getElementById('guestForm').style.display='none';
}

/* =======================
   WHATSAPP
======================== */
async function envoyerWhatsApp(id){
  const snapshot=await database.ref('records/'+id).once('value');
  const r=snapshot.val(); if(!r) return;
  const msg="Reservation: "+r.nom+" - "+r.doc+" / Date: "+r.date;
  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
  await database.ref('records/'+id).update({sent:true});
  if(currentUser.role==='admin') refreshAdmin(); else refreshUser();
}

/* =======================
   START
======================== */
document.getElementById('btnLogin').disabled=false;
const params=new URLSearchParams(location.search);
if(params.has("invite")) enterInviteMode(params.get("invite"));
</script>
</body>
</html>