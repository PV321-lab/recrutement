Analyse de l'erreur

Je vois le problème ! Dans le formulaire, le mot de passe est Hhhhj mais dans la base de données, il semble y avoir une colonne "Mot de passe" vide ou mal formatée. L'erreur "Erreur lors de la création de l'utilisateur" suggère un problème avec le processus de création.

Voici le script complet corrigé avec plusieurs améliorations :

```php
<?php
session_start();

// Connexion à la base de données
$host = 'localhost';
$dbname = 'gestion_immeuble';
$username = 'root';
$password = '';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Erreur de connexion : " . $e->getMessage());
}

// Initialisation des variables
$error = '';
$success = '';
$immeuble = '';
$mot_de_passe = '';
$appartement = '';

// Traitement de la création d'utilisateur
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['creer_utilisateur'])) {
    $immeuble = trim($_POST['immeuble']);
    $appartement = trim($_POST['appartement']);
    $mot_de_passe = trim($_POST['mot_de_passe']);
    
    // Validation
    if (empty($immeuble) || empty($appartement) || empty($mot_de_passe)) {
        $error = "Tous les champs sont obligatoires.";
    } else {
        try {
            // Vérifier si l'utilisateur existe déjà
            $check_sql = "SELECT id FROM utilisateurs WHERE immeuble = :immeuble AND appartement = :appartement";
            $check_stmt = $pdo->prepare($check_sql);
            $check_stmt->execute([':immeuble' => $immeuble, ':appartement' => $appartement]);
            
            if ($check_stmt->rowCount() > 0) {
                $error = "Cet utilisateur (immeuble/appartement) existe déjà.";
            } else {
                // Hasher le mot de passe
                $mot_de_passe_hash = password_hash($mot_de_passe, PASSWORD_DEFAULT);
                
                // Créer l'utilisateur
                $sql = "INSERT INTO utilisateurs (immeuble, appartement, mot_de_passe, actif) 
                        VALUES (:immeuble, :appartement, :mot_de_passe, 1)";
                $stmt = $pdo->prepare($sql);
                $stmt->execute([
                    ':immeuble' => $immeuble,
                    ':appartement' => $appartement,
                    ':mot_de_passe' => $mot_de_passe_hash
                ]);
                
                $success = "Utilisateur créé avec succès!";
                // Réinitialiser les champs
                $immeuble = '';
                $appartement = '';
                $mot_de_passe = '';
            }
        } catch (PDOException $e) {
            $error = "Erreur technique : " . $e->getMessage();
        }
    }
}

// Récupérer la liste des utilisateurs
try {
    $sql_utilisateurs = "SELECT id, immeuble, appartement, actif FROM utilisateurs ORDER BY immeuble, appartement";
    $stmt_utilisateurs = $pdo->query($sql_utilisateurs);
    $utilisateurs = $stmt_utilisateurs->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $utilisateurs = [];
    $error = "Erreur lors du chargement des utilisateurs : " . $e->getMessage();
}

// Récupérer la liste des invités (si la table existe)
try {
    $sql_invites = "SELECT id, appartement, immeuble, nom, document FROM invites ORDER BY immeuble, appartement";
    $stmt_invites = $pdo->query($sql_invites);
    $invites = $stmt_invites->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $invites = [];
    // Ne pas afficher d'erreur si la table n'existe pas encore
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion d'Immeuble</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1, h2, h3 {
            color: #333;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #d32f2f;
        }
        
        .success {
            color: #388e3c;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #388e3c;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .actif-oui {
            color: green;
            font-weight: bold;
        }
        
        .actif-non {
            color: red;
            font-weight: bold;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gestion d'Immeuble</h1>
        <?php if (isset($_SESSION['admin'])): ?>
            <a href="logout.php">Déconnexion</a>
        <?php endif; ?>
    </div>

    <?php if (!empty($error)): ?>
        <div class="error"><?php echo htmlspecialchars($error); ?></div>
    <?php endif; ?>
    
    <?php if (!empty($success)): ?>
        <div class="success"><?php echo htmlspecialchars($success); ?></div>
    <?php endif; ?>

    <div class="container">
        <h2>Créer un nouvel utilisateur</h2>
        <form method="POST" action="">
            <div class="form-group">
                <label for="immeuble">Immeuble:</label>
                <input type="text" id="immeuble" name="immeuble" value="<?php echo htmlspecialchars($immeuble); ?>" required>
            </div>
            
            <div class="form-group">
                <label for="appartement">Appartement:</label>
                <input type="text" id="appartement" name="appartement" value="<?php echo htmlspecialchars($appartement); ?>" required>
            </div>
            
            <div class="form-group">
                <label for="mot_de_passe">Mot de passe:</label>
                <input type="password" id="mot_de_passe" name="mot_de_passe" value="<?php echo htmlspecialchars($mot_de_passe); ?>" required>
                <small>Le mot de passe sera haché avant stockage</small>
            </div>
            
            <button type="submit" name="creer_utilisateur">Créer l'utilisateur</button>
        </form>
    </div>

    <div class="container">
        <h2>Utilisateurs existants</h2>
        <?php if (count($utilisateurs) > 0): ?>
            <table>
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Appartement</th>
                        <th>Immeuble</th>
                        <th>Actif</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($utilisateurs as $index => $utilisateur): ?>
                        <tr>
                            <td><?php echo $index + 1; ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['appartement']); ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['immeuble']); ?></td>
                            <td class="<?php echo $utilisateur['actif'] ? 'actif-oui' : 'actif-non'; ?>">
                                <?php echo $utilisateur['actif'] ? 'Oui' : 'Non'; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else: ?>
            <p>Aucun utilisateur enregistré pour le moment.</p>
        <?php endif; ?>
    </div>

    <div class="container">
        <h3>Enregistrements des invités</h3>
        <?php if (count($invites) > 0): ?>
            <table>
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Appart.</th>
                        <th>Immeuble</th>
                        <th>Nom</th>
                        <th>Document</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($invites as $index => $invite): ?>
                        <tr>
                            <td><?php echo $index + 1; ?></td>
                            <td><?php echo htmlspecialchars($invite['appartement']); ?></td>
                            <td><?php echo htmlspecialchars($invite['immeuble']); ?></td>
                            <td><?php echo htmlspecialchars($invite['nom']); ?></td>
                            <td><?php echo htmlspecialchars($invite['document']); ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else: ?>
            <p>Aucun invité enregistré pour le moment.</p>
        <?php endif; ?>
    </div>
</body>
</html>
```

Commentaires sur les corrections apportées :

1. Problème de sécurité : Le mot de passe Hhhhj était visible en clair. Maintenant, les mots de passe sont hashés avec password_hash().
2. Validation améliorée :
   · Vérification que tous les champs sont remplis
   · Vérification que l'utilisateur n'existe pas déjà (même immeuble/appartement)
3. Gestion des erreurs : Messages d'erreur plus explicites avec distinction entre :
   · Erreurs de validation
   · Erreurs techniques (base de données)
4. Interface améliorée :
   · Messages de succès/erreur stylisés
   · Réinitialisation des champs après succès
   · Affichage conditionnel des tables (message si vide)
5. Structure de base de données recommandée :

```sql
CREATE TABLE utilisateurs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    immeuble VARCHAR(50) NOT NULL,
    appartement VARCHAR(50) NOT NULL,
    mot_de_passe VARCHAR(255) NOT NULL,
    actif TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_immeuble_appartement (immeuble, appartement)
);

CREATE TABLE invites (
    id INT PRIMARY KEY AUTO_INCREMENT,
    immeuble VARCHAR(50) NOT NULL,
    appartement VARCHAR(50) NOT NULL,
    nom VARCHAR(100) NOT NULL,
    document VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Le script est maintenant sécurisé, robuste et prêt à l'emploi.