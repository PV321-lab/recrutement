<!DOCTYPE html>
<html>
<head>
    <title>Test Firebase Connexion</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { margin: 5px; padding: 10px; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h2>Test de connexion Firebase</h2>
    
    <input type="email" id="email" placeholder="Email" value="g.marouane@outlook.fr"><br>
    <input type="password" id="password" placeholder="Mot de passe" value="M@ra10"><br>
    <button onclick="testConnexion()">Tester la connexion et la lecture</button>
    
    <div id="result"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // VOTRE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyC6uSDTNCuw5sHNVaNgq0EzJqJZ9jgic7U",
            authDomain: "dddiii-2b58b.firebaseapp.com",
            databaseURL: "https://dddiii-2b58b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dddiii-2b58b",
            storageBucket: "dddiii-2b58b.firebasestorage.app",
            messagingSenderId: "721468171485",
            appId: "1:721468171485:web:420e2e0ab98b95fa2ae734",
            measurementId: "G-QGFM2N76VK"
        };

        // Initialiser Firebase
        let app, auth, database;
        
        function initFirebase() {
            try {
                // Fermer les anciennes instances
                if (firebase.apps.length > 0) {
                    firebase.apps.forEach(app => {
                        try {
                            app.delete();
                        } catch (e) {
                            console.log("Erreur fermeture app:", e);
                        }
                    });
                }
                
                // Initialiser avec votre config
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                
                console.log("Firebase initialisé avec succès");
                return true;
            } catch (error) {
                console.error("Erreur initialisation Firebase:", error);
                return false;
            }
        }

        async function testConnexion() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('result');
            
            // Afficher chargement
            resultDiv.innerHTML = "Initialisation...";
            resultDiv.className = "loading";
            
            try {
                // 1. Initialiser Firebase
                if (!initFirebase()) {
                    throw new Error("Échec de l'initialisation Firebase");
                }
                
                resultDiv.innerHTML = "Connexion en cours...";
                
                // 2. Se connecter avec email/mot de passe
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                resultDiv.innerHTML = `✓ Connecté !<br>UID: ${user.uid}<br>Email: ${user.email}<br>Test de lecture...`;
                
                // 3. Tester la lecture de la base de données
                try {
                    // Essayer de lire à la racine
                    const snapshot = await database.ref('/').limitToFirst(3).once('value');
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        resultDiv.innerHTML += `<br><br>✓ Lecture réussie !`;
                        resultDiv.innerHTML += `<br>Données trouvées: ${JSON.stringify(data).substring(0, 300)}...`;
                        
                        // Afficher les chemins disponibles
                        resultDiv.innerHTML += `<br><br>Chemins disponibles:`;
                        Object.keys(data).forEach(key => {
                            resultDiv.innerHTML += `<br>• ${key}`;
                        });
                    } else {
                        resultDiv.innerHTML += `<br><br>✓ Connexion DB OK mais aucune donnée trouvée à la racine`;
                    }
                    
                } catch (dbError) {
                    resultDiv.innerHTML += `<br><br>❌ Erreur lecture DB: ${dbError.message}`;
                    resultDiv.innerHTML += `<br><strong>Vérifiez vos règles de sécurité:</strong>`;
                    resultDiv.innerHTML += `<br>Allez sur Firebase Console → Realtime Database → Règles`;
                    resultDiv.innerHTML += `<br>Essayez ces règles temporaires:`;
                    resultDiv.innerHTML += `<pre>{
  "rules": {
    ".read": "auth != null",
    ".write": false
  }
}</pre>`;
                }
                
                resultDiv.className = "success";
                
            } catch (error) {
                resultDiv.innerHTML = `❌ Erreur: ${error.message}`;
                resultDiv.className = "error";
                
                // Aide selon le type d'erreur
                if (error.code === 'auth/user-not-found') {
                    resultDiv.innerHTML += `<br><br>L'utilisateur n'existe pas dans Firebase Authentication.`;
                    resultDiv.innerHTML += `<br>Créez-le dans Firebase Console → Authentication`;
                } else if (error.code === 'auth/wrong-password') {
                    resultDiv.innerHTML += `<br><br>Mot de passe incorrect.`;
                } else if (error.code === 'auth/invalid-api-key') {
                    resultDiv.innerHTML += `<br><br>Clé API invalide. Vérifiez votre configuration.`;
                } else if (error.code === 'auth/network-request-failed') {
                    resultDiv.innerHTML += `<br><br>Problème réseau. Vérifiez votre connexion.`;
                } else if (error.message.includes('asia-southeast1')) {
                    resultDiv.innerHTML += `<br><br>Région de la DB: asia-southeast1`;
                    resultDiv.innerHTML += `<br>Assurez-vous que c'est la bonne région.`;
                }
                
                console.error("Détails erreur:", error);
            }
        }

        // Initialiser au chargement
        window.onload = function() {
            initFirebase();
        };
    </script>
</body>
</html>